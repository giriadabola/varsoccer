<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário de Jogos - VARSOCCER</title>
    <style>
        /* Estilos Globais e do Cabeçalho */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; }
        .page-container { display: flex; flex-direction: column; height: 100vh; }
        header { padding: 10px 20px; background-color: #ffffff; border-bottom: 1px solid #dddfe2; }
        .logo-container { display: inline-flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; }
        .logo-image { height: 40px; width: 40px; }
        .logo-name { font-size: 1.5rem; font-weight: bold; letter-spacing: 1px; }

        /* Layout Específico da Página */
        .content-wrapper { display: flex; flex-grow: 1; overflow: hidden; }
        .calendar-sidebar { width: 300px; flex-shrink: 0; background-color: #ffffff; padding: 20px; overflow-y: auto; border-right: 1px solid #dddfe2; }
        .main-content { flex-grow: 1; padding: 20px; background-color: #f9f9f9; overflow-y: auto; }
        .loading-message { color: #888; }

        /* Estilos do Calendário e Painel de Ano */
        .calendar-widget { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-bottom: 15px; }
        .calendar-header span { cursor: pointer; padding: 5px 10px; border-radius: 4px; user-select: none; }
        .calendar-header span:hover { background-color: #f0f2f5; }
        #cal-month-year:hover { background-color: #f0f2f5; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .calendar-grid .day-name { font-weight: 500; font-size: 0.8rem; color: #666; padding: 4px; }
        .calendar-grid .day-cell { cursor: pointer; padding: 5px 2px; border-radius: 50%; transition: background-color 0.2s; font-size: 0.9rem; }
        .calendar-grid .day-cell:not(.blank):hover { background-color: #f0f2f5; }
        .calendar-grid .day-cell.today { font-weight: bold; border: 1px solid #1877f2; }
        .calendar-grid .day-cell.has-games { font-weight: bold; color: #1877f2; }
        .calendar-grid .day-cell.active { background-color: #1877f2; color: white !important; }
        .calendar-grid .day-cell.blank { cursor: default; }
        
        .year-selection-panel { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(2px); border-radius: 12px; z-index: 20; padding: 10px; }
        .year-selection-panel.visible { display: block; }
        .year-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 8px; max-height: 100%; overflow-y: auto; }
        .year-item { padding: 10px 5px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .year-item:hover { background-color: #e4e6eb; }
        .year-item.active { background-color: #1877f2; color: white; }

        /* Estilos para os filtros na barra lateral */
        .sidebar-filter-group { margin-top: 25px; }
        .sidebar-filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .sidebar-filter-header h3 { font-size: 1.1rem; margin: 0; }
        .clear-btn { background: none; border: none; color: #1877f2; cursor: pointer; font-size: 0.8rem; font-weight: 500; padding: 5px; }
        .clear-btn:hover { text-decoration: underline; }
        
        .filters-container { display: flex; flex-direction: column; gap: 20px; margin-bottom: 20px; }
        #competition-filter { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.9rem; background-color: #fff; }
        .pick-card-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .pick-card { padding: 8px 14px; background-color: #e4e6eb; color: #333; border: 1px solid transparent; border-radius: 18px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
        .pick-card:hover { background-color: #d8dbdf; }
        .pick-card.active { background-color: #1877f2; color: white; border-color: #1877f2; }

        /* Estilos da Lista de Jogos */
        .date-header { font-size: 1.1rem; font-weight: bold; color: #333; margin: 20px 0 10px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        .date-header:first-child { margin-top: 0; }
        .match-list-item { display: grid; grid-template-columns: 28px 1fr auto; align-items: center; gap: 10px; background-color: #fff; padding: 8px 12px; border-radius: 8px; border: 1px solid #eee; text-decoration: none; color: inherit; }
        .match-list-item:hover { background-color: #f9f9f9; border-color: #ccc; }
        .match-list-item .list-item-flag { height: 20px; width: 28px; object-fit: cover; border: 1px solid #eee; }
        .match-list-item .game-name { font-size: 0.9rem; font-weight: 500; }
        .match-list-item .game-jornada { font-size: 0.8rem; color: #666; text-align: right; }
        .main-content h2 { font-size: 1.2rem; font-weight: 600; color: #333; text-align: center; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; padding: 15px 0; margin: 20px 0; }
        .game-name .competition-subtitle { font-size: 0.75rem; font-style: italic; font-weight: 400; color: #555; margin-left: 8px; }
        
        /* Estilos para o novo Dropdown Multi-Select */
        .multi-select-container { position: relative; width: 100%; max-width: 400px; margin: 0 auto; }
        .multi-select-button { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: #fff; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; user-select: none; }
        .multi-select-button #multi-select-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .multi-select-button .arrow { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid #555; transition: transform 0.2s ease; }
        .multi-select-container.open .multi-select-button .arrow { transform: rotate(180deg); }
        .multi-select-dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: #fff; border: 1px solid #ccc; border-top: none; border-radius: 0 0 6px 6px; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .multi-select-container.open .multi-select-dropdown { display: block; }
        .multi-select-dropdown label { display: flex; align-items: center; gap: 10px; padding: 8px 15px; cursor: pointer; transition: background-color 0.2s; }
        .dropdown-comp-logo { width: 24px; height: 24px; object-fit: contain; flex-shrink: 0; }
        .multi-select-dropdown label:hover { background-color: #f0f2f5; }
        .multi-select-dropdown label input { margin-right: 10px; cursor: pointer; }
        :root { --default-color: #1877f2; --active-filter-color: #28a745; }
        .multi-select-container.active-filter .multi-select-button { border-color: var(--active-filter-color); border-width: 2px; }
        .calendar-grid .day-cell.has-selected-comp-games { border: 2px solid var(--active-filter-color); padding: 3px 0; border-radius: 50%; }
        .calendar-grid .day-cell.active.has-selected-comp-games { border-color: white; }
        .multi-select-dropdown label:has(input:disabled) { cursor: not-allowed; color: #999; background-color: #f5f5f5; }
        .multi-select-dropdown label:has(input:disabled):hover { background-color: #f5f5f5; }
    </style>
</head>
<body>
    <div class="page-container">
        <header>
            <a href="index.html" class="logo-container">
                <img src="https://cdn-icons-png.flaticon.com/512/17214/17214595.png" alt="VARSOCCER Logo" class="logo-image">
                <span class="logo-name">VARSOCCER</span>
            </a>
        </header>
        <div class="content-wrapper">
            <aside class="calendar-sidebar">
                <h3>Calendar</h3>
                <div class="calendar-widget" id="mini-calendar">
                    <div class="calendar-header">
                        <span id="cal-prev-month"><</span>
                        <span id="cal-month-year"></span>
                        <span id="cal-next-month">></span>
                    </div>
                    <div class="calendar-grid"></div>
                    <div id="year-selection-panel" class="year-selection-panel"></div>
                </div>
                <div class="sidebar-filter-group">
                    <div class="sidebar-filter-header">
                        <h3>Filter by month</h3>
                        <button id="clear-date-filters-btn" class="clear-btn">Reseat</button>
                    </div>
                    <div id="month-filter-container" class="pick-card-container"><p class="loading-message">Loading...</p></div>
                </div>
            </aside>
            <main class="main-content">
                <div class="filters-container">
                    <div class="multi-select-container" id="competition-filter-container">
                        <div class="multi-select-button">
                            <span id="multi-select-label">All competitions</span>
                            <span class="arrow"></span>
                        </div>
                        <div class="multi-select-dropdown"></div>
                    </div>
                </div>
                <h2>Match list</h2>
                <div id="games-list-container"><p class="loading-message">Loading matches...</p></div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, collection, query, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // --- Configuração Firebase ---
        const firebaseConfig = { apiKey: "AIzaSyBa6zi1FV_WFkatQW-w2vb_votXJ43p76o", authDomain: "varsoccer-26040.firebaseapp.com", projectId: "varsoccer-26040", storageBucket: "varsoccer-26040.firebasestorage.app", messagingSenderId: "11877829810", appId: "1:11877829810:web:98f9baa131a3b88b6e8dab" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const MAX_SELECTIONS = 9;

        // --- Variáveis Globais ---
        let allFetchedGames = [];
        let competitionsMap = new Map();
        let countriesMap = new Map();
        let gameDatesSet = new Set();
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        let currentFilters = { competitionIds: [], month: null, day: null };
        let calendarStateDate = new Date();
        let competitionFilteredGameDatesSet = new Set();
        
        // --- Funções Auxiliares e de Fetch ---
        const formatDate = (dateStr) => new Date(dateStr).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        /**
         * Função auxiliar para converter uma string de data (DD/MM/YYYY ou YYYY-MM-DD) para um objeto Date.
         */
        function parseDate(dateString) {
            if (!dateString) return new Date(null);
            if (dateString.includes('-')) { return new Date(dateString); }
            const parts = dateString.split('/');
            if (parts.length === 3) { return new Date(parts[2], parts[1] - 1, parts[0]); }
            return new Date(null);
        }

        async function fetchAndStoreCompetitions() { if (competitionsMap.size > 0) return; const s = await getDocs(collection(db, 'competicoes')); s.forEach(d => competitionsMap.set(d.id, d.data())); }
        async function fetchAndStoreCountries() { if (countriesMap.size > 0) return; const s = await getDocs(collection(db, 'paises')); s.forEach(d => countriesMap.set(d.id, d.data())); }
        
        // --- Funções de Renderização (sem alterações) ---
        function renderCompetitionFilter() {
            const dropdown = document.querySelector('#competition-filter-container .multi-select-dropdown');
            dropdown.innerHTML = '';
            const competitionEntries = [...competitionsMap.entries()].sort((a,b) => a[1].nome.localeCompare(b[1].nome));
            for(const [id, comp] of competitionEntries){
                const item = document.createElement('label');
                item.innerHTML = `<input type="checkbox" value="${id}"><img src="${comp.logoUrl}" class="dropdown-comp-logo" alt="${comp.nome} logo">${comp.nome}`;
                dropdown.appendChild(item);
            }
        }
        function renderMonthFilter(games) {
            const container = document.getElementById('month-filter-container');
            const uniqueMonths = new Set(games.map(g => parseDate(g.dataJogo).getUTCMonth()));
            container.innerHTML = '';
            monthNames.forEach((name, index) => { if (uniqueMonths.has(index)) { container.innerHTML += `<button class="pick-card" data-month="${index}">${name}</button>`; }});
        }
        function renderGamesList(games) {
            const container = document.getElementById('games-list-container');
            if (games.length === 0) { container.innerHTML = '<p>Nenhum jogo encontrado para os filtros selecionados.</p>'; return; }
            container.innerHTML = '';
            const gamesByDate = games.reduce((acc, game) => { 
                const dateKey = formatDate(game.dataJogo); 
                if (!acc[dateKey]) acc[dateKey] = []; 
                acc[dateKey].push(game); 
                return acc; 
            }, {});
            Object.keys(gamesByDate).sort((a, b) => parseDate(b) - parseDate(a)).forEach(date => {
                container.innerHTML += `<h3 class="date-header">${date}</h3>`;
                gamesByDate[date].sort((a,b) => a.nomeJogo.localeCompare(b.nomeJogo)).forEach(game => {
                    const comp = competitionsMap.get(game.competicaoId);
                    if (!comp) return;
                    const country = countriesMap.get(comp.paisId);
                    const flagUrl = country ? country.bandeiraUrl : '';
                    const countryName = country ? country.nome : 'País Desconhecido';
                    let competitionNameSuffix = (comp.escalao === 'Inferior') ? ` <span class="competition-subtitle">(${comp.nome})</span>` : '';
                    container.innerHTML += `<a href="game.html?id=${game.id}" class="match-list-item"><img src="${flagUrl}" class="list-item-flag" title="${countryName}"><span class="game-name">${game.nomeJogo}${competitionNameSuffix}</span><span class="game-jornada">Round ${game.jornada}</span></a>`;
                });
            });
        }
        function renderCalendar(date) {
            const month = date.getUTCMonth();
            const year = date.getUTCFullYear();
            document.getElementById('cal-month-year').textContent = `${monthNames[month]} ${year}`;
            const grid = document.querySelector('.calendar-widget .calendar-grid');
            grid.innerHTML = '<span class="day-name">D</span><span class="day-name">S</span><span class="day-name">T</span><span class="day-name">Q</span><span class="day-name">Q</span><span class="day-name">S</span><span class="day-name">S</span>';
            const firstDayOfMonth = new Date(Date.UTC(year, month, 1)).getUTCDay();
            const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
            const today = new Date();
            for (let i = 0; i < firstDayOfMonth; i++) { grid.innerHTML += `<span class="day-cell blank"></span>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const cellDate = new Date(Date.UTC(year, month, day));
                const dateString = cellDate.toISOString().split('T')[0];
                const cell = document.createElement('span');
                cell.className = 'day-cell';
                cell.textContent = day;
                cell.dataset.date = dateString;
                if (gameDatesSet.has(dateString)) cell.classList.add('has-games');
                if (competitionFilteredGameDatesSet.has(dateString)) cell.classList.add('has-selected-comp-games');
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) cell.classList.add('today');
                if (day === currentFilters.day && month === currentFilters.month && year === calendarStateDate.getUTCFullYear()) cell.classList.add('active');
                grid.appendChild(cell);
            }
        }
        function renderYearPanel(games) {
            const container = document.getElementById('year-selection-panel');
            const uniqueYears = [...new Set(games.map(g => parseDate(g.dataJogo).getUTCFullYear()))].sort((a,b) => b - a);
            const currentYear = calendarStateDate.getUTCFullYear();
            let content = '<div class="year-grid">';
            uniqueYears.forEach(year => {
                const activeClass = year === currentYear ? 'active' : '';
                content += `<span class="year-item ${activeClass}" data-year="${year}">${year}</span>`;
            });
            content += '</div>';
            container.innerHTML = content;
        }

        // --- Funções de Lógica e Filtros (sem alterações) ---
        function applyFilters() {
            let filteredGames = [...allFetchedGames];
            if (currentFilters.competitionIds.length > 0) {
                filteredGames = filteredGames.filter(g => currentFilters.competitionIds.includes(g.competicaoId));
                competitionFilteredGameDatesSet = new Set(filteredGames.map(g => g.dataJogo.split('T')[0]));
            } else {
                competitionFilteredGameDatesSet.clear();
            }
            if (currentFilters.month !== null) {
                filteredGames = filteredGames.filter(g => parseDate(g.dataJogo).getUTCMonth() == currentFilters.month);
                if (currentFilters.day !== null) {
                    filteredGames = filteredGames.filter(g => parseDate(g.dataJogo).getUTCDate() == currentFilters.day);
                }
            } else {
                const gameDates = [...new Set(filteredGames.map(g => g.dataJogo.split('T')[0]))].sort().reverse();
                const lastTenDaysWithGames = gameDates.slice(0, 10);
                filteredGames = filteredGames.filter(g => lastTenDaysWithGames.includes(g.dataJogo.split('T')[0]));
            }
            renderGamesList(filteredGames);
        }
        function updateCheckboxStates(dropdownElement) {
            const allCheckboxes = dropdownElement.querySelectorAll('input[type="checkbox"]');
            const selectedCount = dropdownElement.querySelectorAll('input[type="checkbox"]:checked').length;
            const limitReached = selectedCount >= MAX_SELECTIONS;
            allCheckboxes.forEach(checkbox => { if (!checkbox.checked) { checkbox.disabled = limitReached; } });
        }
        function updateUIFromFilters() {
            document.querySelectorAll('#month-filter-container .pick-card').forEach(btn => btn.classList.toggle('active', btn.dataset.month == currentFilters.month));
            renderCalendar(calendarStateDate);
            renderYearPanel(allFetchedGames);
            applyFilters();
        }
        function setupFilterListeners() {
            const yearPanel = document.getElementById('year-selection-panel');
            const calTitle = document.getElementById('cal-month-year');
            const calendarWidget = document.getElementById('mini-calendar');
            const compFilterContainer = document.getElementById('competition-filter-container');
            const compFilterButton = compFilterContainer.querySelector('.multi-select-button');
            const compFilterDropdown = compFilterContainer.querySelector('.multi-select-dropdown');
            const compFilterLabel = document.getElementById('multi-select-label');
            compFilterButton.addEventListener('click', () => { compFilterContainer.classList.toggle('open'); });
            compFilterDropdown.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const selectedCheckboxes = compFilterDropdown.querySelectorAll('input:checked');
                    if (selectedCheckboxes.length > MAX_SELECTIONS) {
                        e.target.checked = false;
                        alert(`You can select a maximum of ${MAX_SELECTIONS} competitions.`);
                        return;
                    }
                    currentFilters.competitionIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                    if (currentFilters.competitionIds.length === 0) { compFilterLabel.textContent = 'All competitions'; } 
                    else if (currentFilters.competitionIds.length === 1) { const selectedId = currentFilters.competitionIds[0]; compFilterLabel.textContent = competitionsMap.get(selectedId).nome; } 
                    else { compFilterLabel.textContent = `${currentFilters.competitionIds.length} competitions selected`; }
                    compFilterContainer.classList.toggle('active-filter', currentFilters.competitionIds.length > 0);
                    updateUIFromFilters();
                    updateCheckboxStates(compFilterDropdown);
                }
            });
            document.addEventListener('click', (e) => { if (!compFilterContainer.contains(e.target)) { compFilterContainer.classList.remove('open'); } });
            document.getElementById('month-filter-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('pick-card')) {
                    const month = parseInt(e.target.dataset.month, 10);
                    if (currentFilters.month !== month) {
                        currentFilters.month = month;
                        currentFilters.day = null;
                        calendarStateDate.setUTCFullYear(calendarStateDate.getUTCFullYear(), month, 1);
                        updateUIFromFilters();
                    }
                }
            });
            document.getElementById('clear-date-filters-btn').addEventListener('click', () => {
                currentFilters.month = null;
                currentFilters.day = null;
                calendarStateDate = new Date();
                updateUIFromFilters();
            });
            document.getElementById('cal-prev-month').addEventListener('click', () => { calendarStateDate.setUTCMonth(calendarStateDate.getUTCMonth() - 1); renderCalendar(calendarStateDate); });
            document.getElementById('cal-next-month').addEventListener('click', () => { calendarStateDate.setUTCMonth(calendarStateDate.getUTCMonth() + 1); renderCalendar(calendarStateDate); });
            document.querySelector('.calendar-widget .calendar-grid').addEventListener('click', (e) => {
                if (e.target.classList.contains('day-cell') && !e.target.classList.contains('blank')) {
                    const clickedDate = new Date(e.target.dataset.date + 'T00:00:00Z');
                    currentFilters.month = clickedDate.getUTCMonth();
                    currentFilters.day = clickedDate.getUTCDate();
                    calendarStateDate = clickedDate;
                    updateUIFromFilters();
                }
            });
            calTitle.addEventListener('click', (event) => { event.stopPropagation(); yearPanel.classList.toggle('visible'); });
            yearPanel.addEventListener('click', (e) => {
                if (e.target.classList.contains('year-item')) {
                    const year = parseInt(e.target.dataset.year, 10);
                    calendarStateDate.setUTCFullYear(year);
                    currentFilters.month = null;
                    currentFilters.day = null;
                    updateUIFromFilters();
                    yearPanel.classList.remove('visible');
                }
            });
            document.addEventListener('click', (e) => { if (!calendarWidget.contains(e.target)) { yearPanel.classList.remove('visible'); } });
        }
        
        // --- FUNÇÃO DE INICIALIZAÇÃO (MODIFICADA) ---
        async function initializeCalendarPage() {
            // 1. Carrega dados de suporte primeiro
            await Promise.all([fetchAndStoreCompetitions(), fetchAndStoreCountries()]);

            // 2. Busca todos os jogos do Firebase
            const gamesQuery = query(collection(db, 'jogos'), orderBy("dataJogo", "desc"));
            const snapshot = await getDocs(gamesQuery);
            const rawGames = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // 3. APLICA A NOVA LÓGICA DE FILTRAGEM
            const now = new Date();
            now.setHours(0, 0, 0, 0); // Compara com o início do dia atual

            allFetchedGames = rawGames.filter(game => {
                const gameDate = parseDate(game.dataJogo);
                if (isNaN(gameDate.getTime())) {
                    return true; // Mantém o jogo por segurança se a data for inválida
                }
                const isFutureGame = gameDate > now;
                const hasInvalidResult = !game.resultadoFinal || game.resultadoFinal.trim() === "" || game.resultadoFinal.toUpperCase() === 'X';

                // Mantém o jogo a menos que seja futuro E tenha resultado inválido
                return !(isFutureGame && hasInvalidResult);
            });

            // 4. Popula o conjunto de datas a partir da lista JÁ FILTRADA
            allFetchedGames.forEach(game => {
                gameDatesSet.add(game.dataJogo.split('T')[0]);
            });

            // 5. Continua a inicialização da página com os dados limpos
            applyFilters();
            renderCompetitionFilter();
            renderMonthFilter(allFetchedGames);
            renderCalendar(calendarStateDate);
            renderYearPanel(allFetchedGames);
            setupFilterListeners();
        }

        initializeCalendarPage();
    </script>
</body>
</html>
