<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navegador de Jogos para Edição</title>
    
    <style>
        /* ESTILOS BÁSICOS */
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; color: #333; margin: 0; padding: 20px; font-size: 0.9em; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; padding: 20px; }
        h1 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5em; }
        .editor-main { display: flex; gap: 20px; min-height: 500px; }

        /* --- Coluna de Navegação --- */
        .navigation-column { flex: 1; border-right: 1px solid #ddd; padding-right: 20px; display: flex; flex-direction: column; gap: 15px; }
        .navigation-column select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        .nav-header { display: flex; align-items: center; gap: 10px; }
        #backButton { background: none; border: 1px solid #ccc; border-radius: 50%; width: 30px; height: 30px; font-size: 1.2em; cursor: pointer; display: none; }
        #backButton:hover { background-color: #f0f0f0; }
        .nav-header h2 { font-size: 1.1em; margin: 0; color: #555; }
        .list-container { flex-grow: 1; overflow-y: auto; max-height: 500px; border: 1px solid #eee; border-radius: 4px; padding: 5px; }
        .nav-list { list-style: none; padding: 0; margin: 0; }
        .nav-list.hidden { display: none; }

        .nav-list-item { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 10px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; border: 1px solid transparent; transition: background-color 0.2s, border-color 0.2s; }
        .nav-list-item .item-content { display: flex; align-items: center; gap: 8px; }
        .nav-list-item:hover { background-color: #f0f2f5; }
        .nav-list-item.active { background-color: #007bff; color: white; font-weight: bold; border-color: #0056b3; }
        .nav-list-item.missing-video { background-color: #fff0f0; border-color: #f5c6cb; }
        .nav-list-item.missing-video:hover { background-color: #ffe5e5; }
        .nav-list-item.missing-video.active { background-color: #e60000; color: white; border-color: #c00; }
        .nav-icon { font-size: 1.2em; }
        .loading-message, .info-message { color: #888; padding: 10px; }

        .missing-count-badge { background-color: #dc3545; color: white; border-radius: 50%; min-width: 20px; height: 20px; font-size: 0.8em; font-weight: bold; display: flex; align-items: center; justify-content: center; padding: 2px; line-height: 1; }

        /* PAINEL DE EDIÇÃO (Direita) */
        .edit-panel-column { flex: 1.5; }
        
        /* **NOVO** Estilos para o cabeçalho do painel com logotipos */
        .panel-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px; /* Mantém o espaçamento que o h2 tinha */
        }
        .panel-header h2 {
            margin: 0; /* Remove margem padrão do h2 */
            flex-shrink: 0; /* Impede que o texto encolha */
        }
        .logo-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .logo-container img {
            height: 32px; /* Altura controlada para os logotipos */
            width: auto;
            object-fit: contain;
            display: none; /* Escondido por defeito, JS irá mostrar */
        }

        #videoForm fieldset { border: 1px solid #ddd; padding: 15px; border-radius: 4px; }
        #videoForm fieldset:disabled { opacity: 0.5; cursor: not-allowed; }
        #selectedGameName { font-weight: bold; background-color: #e9ecef; padding: 10px; border-radius: 4px; margin-bottom: 15px; min-height: 20px; }
        .form-group { margin-bottom: 12px; display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 4px; font-weight: bold; }
        .form-group input[type="url"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box; }
        .form-group.checkbox-group { flex-direction: row; align-items: center; gap: 8px; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        .action-btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
        .action-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        .save-btn { background-color: #28a745; color: white; }
        .search-btn { background-color: #6c757d; color: white; }
        #videoPreview { margin-top: 20px; }
        #videoPreview iframe { max-width: 100%; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Navegador e Editor de Vídeos</h1>
        <div class="editor-main">
            <div class="navigation-column">
                <div>
                    <label for="seasonSelector" style="font-weight: bold; margin-bottom: 5px; display: block;">Temporada</label>
                    <select id="seasonSelector"><option>A carregar...</option></select>
                </div>
                <div>
                    <div class="nav-header">
                        <button id="backButton">←</button>
                        <h2 id="navigationTitle">Competições</h2>
                    </div>
                    <div class="list-container">
                        <ul id="competitionsList" class="nav-list"></ul>
                        <ul id="roundsList" class="nav-list hidden"></ul>
                        <ul id="gamesList" class="nav-list hidden"></ul>
                    </div>
                </div>
            </div>

            <div class="edit-panel-column">
                 <!-- **HTML MODIFICADO**: O h2 foi envolvido para permitir o alinhamento com os logotipos -->
                <div class="panel-header">
                    <h2>Painel de Edição</h2>
                    <div class="logo-container">
                        <img id="logoCasa" src="" alt="Logo Equipa Casa">
                        <img id="logoFora" src="" alt="Logo Equipa Visitante">
                    </div>
                </div>
                <form id="videoForm">
                    <fieldset id="videoFormFieldset" disabled>
                        <div class="form-group">
                            <label>Jogo Selecionado:</label>
                            <div id="selectedGameName">Selecione um jogo da lista</div>
                        </div>
                        <div class="form-group">
                            <label for="videoUrlInput">Link do Vídeo (YouTube, etc.)</label>
                            <input type="url" id="videoUrlInput" placeholder="https://exemplo.com/video" required>
                        </div>
                         <div class="form-group checkbox-group">
                            <input type="checkbox" id="useApiYtCheckbox">
                            <label for="useApiYtCheckbox" style="margin-bottom: 0; font-weight: normal;">Usar apenas link (não incorporar)</label>
                        </div>
                        <div class="button-group">
                            <button type="button" id="searchYouTubeBtn" class="action-btn search-btn">Procurar no YouTube</button>
                            <button type="submit" id="saveBtn" class="action-btn save-btn">Gravar</button>
                        </div>
                        <div id="videoPreview"></div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>

     <script type="module">
    // **JS MODIFICADO**: Adicionado "getDoc" ao import
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyBa6zi1FV_WFkatQW-w2vb_votXJ43p76o", authDomain: "varsoccer-26040.firebaseapp.com", projectId: "varsoccer-26040", storageBucket: "varsoccer-26040.firebasestorage.app", messagingSenderId: "11877829810", appId: "1:11877829810:web:98f9baa131a3b88b6e8dab" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Elementos do DOM ---
    const seasonSelector = document.getElementById('seasonSelector');
    const navigationTitle = document.getElementById('navigationTitle');
    const backButton = document.getElementById('backButton');
    const competitionsList = document.getElementById('competitionsList');
    const roundsList = document.getElementById('roundsList');
    const gamesList = document.getElementById('gamesList');
    const videoFormFieldset = document.getElementById('videoFormFieldset');
    const selectedGameNameElement = document.getElementById('selectedGameName');
    const videoUrlInputElement = document.getElementById('videoUrlInput');
    const useApiYtCheckbox = document.getElementById('useApiYtCheckbox');
    const searchYouTubeBtn = document.getElementById('searchYouTubeBtn');
    const saveBtn = document.getElementById('saveBtn');
    const videoPreviewElement = document.getElementById('videoPreview');
    // **JS MODIFICADO**: Referências para as imagens dos logotipos
    const logoCasaImg = document.getElementById('logoCasa');
    const logoForaImg = document.getElementById('logoFora');

    // --- Estado da Aplicação ---
    let gamesCache = new Map();
    let competitionGamesCache = [];
    let allSeasonGamesCache = [];
    let selectedGame = null;
    let navigationState = { view: 'competitions', competitionId: null, roundNumber: null };

    // --- Funções de Lógica e Renderização ---

    // **NOVA FUNÇÃO**: Busca a URL do logotipo de uma equipa pelo seu ID na coleção 'clubes'.
    const getLogoUrl = async (teamId) => {
        if (!teamId) return null;
        try {
            const teamRef = doc(db, 'clubes', teamId);
            const teamSnap = await getDoc(teamRef);
            if (teamSnap.exists() && teamSnap.data().logoUrl) {
                return teamSnap.data().logoUrl;
            }
            return null;
        } catch (error) {
            console.error(`Erro ao buscar logo para equipa ${teamId}:`, error);
            return null;
        }
    };
    
    const isVideoMissing = (game) => !game.videoUrl || game.videoUrl.trim() === '';

    const updateView = (view, title) => {
        navigationState.view = view;
        navigationTitle.textContent = title;
        competitionsList.classList.toggle('hidden', view !== 'competitions');
        roundsList.classList.toggle('hidden', view !== 'rounds');
        gamesList.classList.toggle('hidden', view !== 'games');
        backButton.style.display = view === 'competitions' ? 'none' : 'inline-block';
        if (view !== 'games') {
            resetEditorPanel();
        }
    };
    
    // **JS MODIFICADO**: Adicionado o reset dos logotipos
    const resetEditorPanel = () => {
         videoFormFieldset.disabled = true;
         selectedGameNameElement.textContent = 'Selecione um jogo da lista';
         videoUrlInputElement.value = '';
         useApiYtCheckbox.checked = false;
         videoPreviewElement.innerHTML = '';
         selectedGame = null;
         document.querySelectorAll('.nav-list-item.active').forEach(el => el.classList.remove('active'));
         // Esconde e limpa os logotipos
         logoCasaImg.style.display = 'none';
         logoForaImg.style.display = 'none';
         logoCasaImg.src = '';
         logoForaImg.src = '';
    };

    const loadSeasons = async () => {
        const seasonsQuery = query(collection(db, "temporadas"), orderBy("nome", "desc"));
        const snapshot = await getDocs(seasonsQuery);
        seasonSelector.innerHTML = snapshot.docs.map(doc => `<option value="${doc.data().nome}">${doc.data().nome}</option>`).join('');
        await loadCompetitions();
    };

    const loadCompetitions = async () => {
        resetEditorPanel();
        updateView('competitions', 'Competições');
        competitionsList.innerHTML = '<li class="loading-message">A carregar...</li>';
        
        const selectedSeason = seasonSelector.value;
        const gamesQuery = query(collection(db, "jogos"), where("temporada", "==", selectedSeason));
        const gamesSnapshot = await getDocs(gamesQuery);
        allSeasonGamesCache = gamesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const competitionsSnapshot = await getDocs(collection(db, "competicoes"));
        if(competitionsSnapshot.empty) {
            competitionsList.innerHTML = '<li class="info-message">Nenhuma competição encontrada.</li>';
            return;
        }

        competitionsList.innerHTML = competitionsSnapshot.docs.map(doc => {
            const competitionId = doc.id;
            const gamesInComp = allSeasonGamesCache.filter(g => g.competicaoId === competitionId);
            const missingCount = gamesInComp.filter(isVideoMissing).length;
            const badgeHtml = missingCount > 0 ? `<span class="missing-count-badge">${missingCount}</span>` : '';
            return `<li class="nav-list-item" data-id="${competitionId}"><span class="item-content">${doc.data().nome}</span>${badgeHtml}</li>`;
        }).join('');
    };

    const loadRounds = async (competitionId) => {
        const compItem = document.querySelector(`#competitionsList li[data-id="${competitionId}"] .item-content`);
        const competitionName = compItem ? compItem.textContent : 'Competição';
        navigationState.competitionId = competitionId;
        updateView('rounds', `Jornadas de ${competitionName}`);
        roundsList.innerHTML = '<li class="loading-message">A carregar...</li>';
        
        competitionGamesCache = allSeasonGamesCache.filter(game => game.competicaoId === competitionId);

        if(competitionGamesCache.length === 0) {
            roundsList.innerHTML = '<li class="info-message">Nenhuma jornada encontrada para esta competição/temporada.</li>';
            return;
        }

        const roundNumbers = [...new Set(competitionGamesCache.map(game => game.jornada))].sort((a, b) => a - b);
        roundsList.innerHTML = roundNumbers.map(num => {
            const gamesInRound = competitionGamesCache.filter(g => g.jornada == num);
            const missingCount = gamesInRound.filter(isVideoMissing).length;
            const badgeHtml = missingCount > 0 ? `<span class="missing-count-badge">${missingCount}</span>` : '';
            return `<li class="nav-list-item" data-round="${num}"><span class="item-content">Jornada ${num}</span>${badgeHtml}</li>`;
        }).join('');
    };

    const loadGames = (roundNumber) => {
        navigationState.roundNumber = roundNumber;
        updateView('games', `Jogos da Jornada ${roundNumber}`);
        const gamesForRound = competitionGamesCache.filter(game => game.jornada == roundNumber);
        gamesCache.clear();
        gamesForRound.forEach(game => gamesCache.set(game.id, game));

        if(gamesForRound.length === 0) {
            gamesList.innerHTML = '<li class="info-message">Nenhum jogo encontrado.</li>';
            return;
        }
        
        gamesList.innerHTML = gamesForRound.map(game => {
            const hasVideo = !isVideoMissing(game);
            const videoIcon = game.apiYt === true ? '🔗' : '🎬';
            return `<li class="nav-list-item ${!hasVideo ? 'missing-video' : ''}" data-id="${game.id}"><div class="item-content"><span class="nav-icon">${hasVideo ? videoIcon : '❌'}</span><span>${game.nomeJogo}</span></div></li>`;
        }).join('');
    };
    
    // **JS MODIFICADO**: Função agora é 'async' para esperar pelos logotipos
    const selectGame = async (gameId) => {
        selectedGame = gamesCache.get(gameId);
        if (selectedGame) {
            document.querySelectorAll('#gamesList .active').forEach(el => el.classList.remove('active'));
            document.querySelector(`#gamesList li[data-id="${gameId}"]`).classList.add('active');
            
            videoFormFieldset.disabled = false;
            selectedGameNameElement.textContent = selectedGame.nomeJogo;
            videoUrlInputElement.value = selectedGame.videoUrl || '';
            useApiYtCheckbox.checked = selectedGame.apiYt === true;
            videoUrlInputElement.dispatchEvent(new Event('input'));

            // **JS MODIFICADO**: Lógica para buscar e exibir os logotipos
            logoCasaImg.style.display = 'none';
            logoForaImg.style.display = 'none';

            const [logoCasaUrl, logoForaUrl] = await Promise.all([
                getLogoUrl(selectedGame.equipaCasaId),
                getLogoUrl(selectedGame.equipaForaId)
            ]);

            if (logoCasaUrl) {
                logoCasaImg.src = logoCasaUrl;
                logoCasaImg.style.display = 'block';
            }
            if (logoForaUrl) {
                logoForaImg.src = logoForaUrl;
                logoForaImg.style.display = 'block';
            }
        }
    };

    const updateCompetitionBadge = (competitionId) => {
        const listItem = competitionsList.querySelector(`li[data-id="${competitionId}"]`);
        if (!listItem) return;
        const gamesInComp = allSeasonGamesCache.filter(g => g.competicaoId === competitionId);
        const missingCount = gamesInComp.filter(isVideoMissing).length;
        let badge = listItem.querySelector('.missing-count-badge');
        if (missingCount > 0) {
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'missing-count-badge';
                listItem.appendChild(badge);
            }
            badge.textContent = missingCount;
        } else if (badge) {
            badge.remove();
        }
    };
    
    const updateRoundBadge = (roundNumber) => {
        const listItem = roundsList.querySelector(`li[data-round="${roundNumber}"]`);
        if (!listItem) return;
        const gamesInRound = competitionGamesCache.filter(g => g.jornada == roundNumber);
        const missingCount = gamesInRound.filter(isVideoMissing).length;
        let badge = listItem.querySelector('.missing-count-badge');
        if (missingCount > 0) {
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'missing-count-badge';
                listItem.appendChild(badge);
            }
            badge.textContent = missingCount;
        } else if (badge) {
            badge.remove();
        }
    };

    // --- Event Listeners ---
    seasonSelector.addEventListener('change', loadCompetitions);

    backButton.addEventListener('click', () => {
        if (navigationState.view === 'games') {
            const compItem = document.querySelector(`#competitionsList li[data-id="${navigationState.competitionId}"] .item-content`);
            const competitionName = compItem ? compItem.textContent : 'Competição';
            updateView('rounds', `Jornadas de ${competitionName}`);
        } else if (navigationState.view === 'rounds') {
            updateView('competitions', 'Competições');
        }
    });

    competitionsList.addEventListener('click', (e) => {
        const li = e.target.closest('.nav-list-item');
        if (li) loadRounds(li.dataset.id);
    });

    roundsList.addEventListener('click', (e) => {
        const li = e.target.closest('.nav-list-item');
        if (li) loadGames(li.dataset.round);
    });

    // **JS MODIFICADO**: Event listener agora é 'async' para poder usar 'await' na chamada da função
    gamesList.addEventListener('click', async (e) => {
        const li = e.target.closest('.nav-list-item');
        if (li) await selectGame(li.dataset.id);
    });
    
    videoUrlInputElement.addEventListener('input', () => {
        const url = videoUrlInputElement.value.trim();
        const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const match = url.match(youtubeRegex);
        if (match && match[1]) {
            videoPreviewElement.innerHTML = `<iframe width="560" height="315" src="https://www.youtube.com/embed/${match[1]}" frameborder="0" allowfullscreen></iframe>`;
        } else {
            videoPreviewElement.innerHTML = '';
        }
    });

    searchYouTubeBtn.addEventListener('click', () => {
        if (!selectedGame) return;
        const searchTerm = encodeURIComponent(selectedGame.nomeJogo);
        window.open(`https://www.youtube.com/results?search_query=${searchTerm}`, '_blank');
    });

    videoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!selectedGame || saveBtn.disabled) return;

        const videoUrl = videoUrlInputElement.value.trim();
        const useApi = useApiYtCheckbox.checked;

        const originalBtnText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.textContent = 'A gravar...';

        try {
            await updateDoc(doc(db, 'jogos', selectedGame.id), { videoUrl: videoUrl, apiYt: useApi });
            
            const gameInCache = allSeasonGamesCache.find(g => g.id === selectedGame.id);
            if (gameInCache) {
                gameInCache.videoUrl = videoUrl;
                gameInCache.apiYt = useApi;
            }
            
            saveBtn.textContent = 'Gravado!';
            saveBtn.style.backgroundColor = '#218838';

            const gameListItem = gamesList.querySelector(`li[data-id="${selectedGame.id}"]`);
            if (gameListItem) {
                const iconEl = gameListItem.querySelector('.nav-icon');
                const hasVideo = !isVideoMissing(gameInCache);
                gameListItem.classList.toggle('missing-video', !hasVideo);
                iconEl.textContent = hasVideo ? (useApi ? '🔗' : '🎬') : '❌';
            }
            
            updateRoundBadge(navigationState.roundNumber);
            updateCompetitionBadge(navigationState.competitionId);

            setTimeout(() => {
                saveBtn.textContent = originalBtnText;
                saveBtn.style.backgroundColor = '#28a745';
                saveBtn.disabled = false;
            }, 2000);

        } catch (error) {
            console.error("Erro ao gravar o vídeo: ", error);
            saveBtn.textContent = originalBtnText;
            saveBtn.style.backgroundColor = '#28a745';
            saveBtn.disabled = false;
            alert("Ocorreu um erro ao gravar. Tente novamente.");
        }
    });

    document.addEventListener('DOMContentLoaded', loadSeasons);
</script>
</body>
</html>
