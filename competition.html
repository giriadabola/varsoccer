<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Competition Details</title>
    <style>
        /* Reset & Global Styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; }
        .page-container { display: flex; flex-direction: column; height: 100vh; }
        
        header { padding: 10px 20px; background-color: #ffffff; border-bottom: 1px solid #dddfe2; }
        .logo-container { display: inline-flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; }
        .logo-image { height: 40px; width: 40px; }
        .logo-name { font-size: 1.5rem; font-weight: bold; letter-spacing: 1px; }

        .content-wrapper { display: flex; flex-grow: 1; overflow: hidden; }
        .sidebar { width: 280px; flex-shrink: 0; background-color: #ffffff; padding: 15px; overflow-y: auto; border-right: 1px solid #dddfe2; }
        
        .sidebar h2 { font-size: 1.1rem; margin-bottom: 5px; color: #333; }
        .loading-message { color: #888; }
        .team-item { display: flex; align-items: center; padding: 4px; border-radius: 6px; margin-bottom: 2px; text-decoration: none; color: inherit; transition: background-color 0.2s ease-in-out; }
        .team-item:hover { background-color: #f0f2f5; }
        .team-logo { width: 24px; height: 24px; object-fit: contain; margin-right: 8px; }
        .team-name { font-weight: 500; font-size: 0.9rem; }
        
        .main-content { flex-grow: 1; padding: 20px; background-color: #f9f9f9; overflow-y: auto; }
        
        /* --- ESTILOS MODIFICADOS PARA PICK CARDS --- */
        #other-competitions-section {
            padding: 15px;
            margin-bottom: 20px;
            background-color: #e9ecef; /* Cor de fundo diferente */
            border-radius: 8px;
            border-bottom: 1px solid #d1d5db;
        }
        #other-competitions-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .competition-pick-card {
            display: flex;
            align-items: center;
            gap: 6px; /* Reduzido */
            padding: 6px 10px; /* Reduzido */
            background-color: #fff;
            border-radius: 8px;
            text-decoration: none;
            color: inherit;
            transition: background-color 0.2s, box-shadow 0.2s;
            border: 1px solid #e0e0e0;
        }
        .competition-pick-card:hover {
            background-color: #f7f7f7;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .competition-pick-card img {
            height: 20px; /* Reduzido */
            width: 20px;  /* Reduzido */
            object-fit: contain;
        }
        .competition-pick-card span {
            font-size: 0.8rem; /* Reduzido */
            font-weight: 500;
        }
        /* --- FIM DAS MODIFICAÇÕES --- */

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #dddfe2; padding-bottom: 20px; }
        #competition-header { display: flex; align-items: center; gap: 15px; }
        #competition-logo { height: 50px; }
        #competition-name { font-size: 1.8rem; font-weight: bold; }
        #seasons-dropdown { padding: 8px 12px; font-size: 0.95rem; border-radius: 8px; border: 1px solid #ccc; }
        
        #games-grid-container { padding-bottom: 25px; border-bottom: 1px solid #dddfe2; margin-bottom: 20px;}
        #games-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .game-card { background-color: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; width: 180px; height: 120px; display: flex; flex-direction: column; justify-content: center; }
        .game-card-jornada { position: absolute; top: 10px; right: 10px; background-color: #f0f2f5; color: #606770; font-size: 0.7rem; padding: 3px 7px; border-radius: 6px; font-weight: bold; }
        .game-card-content { display: flex; align-items: center; justify-content: space-around; width: 100%; }
        .game-card-team { display: flex; align-items: center; justify-content: center; width: 45px; text-decoration: none; }
        .game-card-team img { height: 40px; width: 40px; object-fit: contain; }
        .game-card-result { font-size: 1.4rem; font-weight: bold; margin: 0 5px; text-decoration: none; color: inherit; }
        
        #more-matches-section { padding-bottom: 25px; margin-top: 20px; }
        #more-matches-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #more-matches-header h2 { font-size: 1.5rem; margin: 0; padding: 0; border: none; }
        #jornada-dropdown { padding: 8px 12px; font-size: 0.95rem; border-radius: 8px; border: 1px solid #ccc; }
        #more-matches-list { display: flex; flex-direction: column; gap: 8px; }
        
        .match-list-item { display: flex; align-items: center; gap: 12px; background-color: #fff; padding: 10px 15px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.08); text-decoration: none; color: inherit; transition: background-color 0.2s ease; }
        .match-list-item:hover { background-color: #f0f2f5; }
        .match-list-item img { height: 24px; width: 24px; object-fit: contain; }
        .match-list-item span { font-size: 0.95rem; }

     .menu-toggle-btn {
    display: none;
}
/* Estilo do overlay, escondido por padrão */
.page-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

@media (max-width: 992px) {
    /* Transforma a sidebar em um menu off-canvas */
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        z-index: 1000;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    
    /* Estilo do botão do menu */
    .menu-toggle-btn {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        width: 30px;
        height: 30px;
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0;
        z-index: 10;
    }
    .menu-toggle-btn span {
        width: 30px;
        height: 3px;
        background: #1c1e21;
        border-radius: 5px;
    }

    /* Reorganiza o cabeçalho com alinhamento perfeito */
    header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
    }
    
    .menu-toggle-btn { order: 1; }
    .logo-container { order: 2; }
    header::after {
        content: '';
        width: 30px;
        order: 3;
    }

    /* Oculta o conteúdo principal quando o menu está aberto */
    body.sidebar-open .content-wrapper {
        overflow: hidden;
    }

    /* Estado "Aberto" do menu */
    body.sidebar-open .sidebar {
        transform: translateX(0);
    }
    body.sidebar-open .page-overlay {
        opacity: 1;
        visibility: visible;
    }

    /* Ajustes específicos para o conteúdo desta página */
    .section-header {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
        padding-bottom: 15px;
        margin-bottom: 15px;
    }
    #competition-name {
        font-size: 1.5rem; /* Reduz a fonte do nome da competição */
    }
    #games-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
    .game-card {
        width: 100%; /* Permite que o card ocupe o espaço da coluna */
    }
    #other-competitions-grid {
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 10px;
    }
}

    </style>
</head>
<body>
    <div class="page-container">
        <header>
                  <button id="menu-toggle-btn" class="menu-toggle-btn">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <a href="index.html" class="logo-container">
                <img src="https://cdn-icons-png.flaticon.com/512/17214/17214595.png" alt="VARSOCCER Logo" class="logo-image">
                <span class="logo-name">VARSOCCER</span>
            </a>
        </header>
        <div class="content-wrapper">
            <nav class="sidebar">
                <div id="team-list"><p class="loading-message">Select a season.</p></div>
            </nav>
             <div id="page-overlay" class="page-overlay"></div>
            <main class="main-content">
                <section id="other-competitions-section" style="display: none;">
                    <div id="other-competitions-grid"></div>
                </section>

                <div class="section-header">
                    <div id="competition-header"><p class="loading-message">Loading details...</p></div>
                    <div id="seasons-dropdown-container"></div>
                </div>
                <div id="games-grid-container">
                     <p class="loading-message" id="games-loading-message">Select a season.</p>
                     <div id="games-grid"></div>
                </div>
                <section id="more-matches-section" style="display: none;">
                    <div id="more-matches-header">
                        <h2>More Matches</h2>
                        <div id="jornada-dropdown-container"></div>
                    </div>
                    <div id="more-matches-list-container">
                        <p class="loading-message" id="more-matches-loading-message">Select a round.</p>
                        <div id="more-matches-list"></div>
                    </div>
                </section>
            </main>
        </div>
    </div>

  <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // --- Configuração do Firebase (sem alterações) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBa6zi1FV_WFkatQW-w2vb_votXJ43p76o",
            authDomain: "varsoccer-26040.firebaseapp.com",
            projectId: "varsoccer-26040",
            storageBucket: "varsoccer-26040.firebasestorage.app",
            messagingSenderId: "11877829810",
            appId: "1:11877829810:web:98f9baa131a3b88b6e8dab"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Variáveis globais (sem alterações) ---
        let clubsMap = new Map();
        let gamesOfSeason = [];
        let currentCompetitionData = null;

        // --- FUNÇÃO MODIFICADA: fetchCompetitionDetails ---
        const fetchCompetitionDetails = async (id) => {
            console.log(`[LOG] A iniciar a busca por detalhes da competição com ID: ${id}`);
            const docRef = doc(db, 'competicoes', id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                console.log("[LOG] Competição encontrada na base de dados:", docSnap.data());
                currentCompetitionData = docSnap.data();
                document.getElementById('competition-header').innerHTML = `<img src="${currentCompetitionData.logoUrl}" id="competition-logo"><h1 id="competition-name">${currentCompetitionData.nome}</h1>`;
                return currentCompetitionData;
            } else {
                // ISTO É O QUE PROVAVELMENTE ESTÁ A ACONTECER
                console.error(`[ERRO] Competição com o ID '${id}' NÃO FOI ENCONTRADA na base de dados.`);
                
                // Adicionei uma mensagem de erro clara para substituir o "Loading..."
                document.getElementById('competition-header').innerHTML = `<h1>Erro: Competição não encontrada.</h1>`;
                document.querySelector('.main-content').innerHTML = `<h1>Competição com ID '${id}' não encontrada.</h1><p>Por favor, verifique se o link está correto.</p>`;
                
                return null; // Retorna nulo como antes, indicando falha
            }
        };

           // --- Restante do código (sem alterações, apenas colado abaixo para ser completo) ---
        const fetchAndStoreClubs = async () => { if(clubsMap.size > 0) return; const s=await getDocs(collection(db,'clubes')); s.forEach(d=>clubsMap.set(d.id,d.data())); };
        const fetchAllGamesForSeason = async (competitionId, seasonName) => { const lm=document.getElementById('games-loading-message'); lm.textContent=`Loading season matches for ${seasonName}...`; lm.style.display='block'; document.getElementById('more-matches-section').style.display='none'; const gq=query(collection(db,'jogos'),where("competicaoId","==",competitionId),where("temporada","==",seasonName)); const sn=await getDocs(gq); const rawGames=[]; sn.forEach(d=>rawGames.push({id:d.id,...d.data()})); const now=new Date(); now.setHours(0,0,0,0); gamesOfSeason=rawGames.filter(game=>{ const gameDate=parseDate(game.dataJogo); if(isNaN(gameDate.getTime()))return true; const isFutureGame=gameDate > now; const hasInvalidResult=!game.resultadoFinal || game.resultadoFinal.trim()==="" || game.resultadoFinal.toUpperCase()==='X'; return !(isFutureGame && hasInvalidResult); }); if(gamesOfSeason.length===0){ lm.textContent='No matches found for this season with the current filter.'; document.getElementById('games-grid').innerHTML=''; document.getElementById('team-list').innerHTML='<p>No teams found.</p>'; return; } gamesOfSeason.sort((a,b)=>parseDate(a.dataJogo) - parseDate(b.dataJogo)); lm.style.display='none'; renderTeamsList(gamesOfSeason); renderLatestGamesGrid(gamesOfSeason); renderJornadaDropdown(gamesOfSeason); document.getElementById('more-matches-section').style.display='block'; };
        const renderTeamsList = (games) => { const tI = new Set(); games.forEach(g => { tI.add(g.equipaCasaId); tI.add(g.equipaForaId); }); const ts = []; tI.forEach(id => { if (clubsMap.has(id)) { ts.push({ id, ...clubsMap.get(id) }); } }); ts.sort((a, b) => a.nome.localeCompare(b.nome)); const le = document.getElementById('team-list'); le.innerHTML = '<h2>Teams</h2>'; ts.forEach(t => { le.innerHTML += `<a href="team.html?id=${t.id}" class="team-item"><img src="${t.logoUrl}" alt="${t.nome}" class="team-logo"><span class="team-name">${t.nome}</span></a>`; }); };
        const renderLatestGamesGrid = (games) => { const gg=document.getElementById('games-grid'); gg.innerHTML=''; if(games.length===0)return; const ln=games[games.length - 1].jornada; const lg=games.filter(g=>String(g.jornada)==String(ln)); lg.forEach(g=>{ const ht=clubsMap.get(g.equipaCasaId); const at=clubsMap.get(g.equipaForaId); if(!ht || !at)return; gg.innerHTML+=`<div class="game-card"><div class="game-card-jornada">${isNaN(g.jornada)? g.jornada:'Round ' + g.jornada}</div><div class="game-card-content"><a href="team.html?id=${g.equipaCasaId}" class="game-card-team"><img src="${ht.logoUrl}"></a><a href="game.html?id=${g.id}" class="game-card-result">${g.resultadoFinal || 'VS'}</a><a href="team.html?id=${g.equipaForaId}" class="game-card-team"><img src="${at.logoUrl}"></a></div></div>`; }); };
        const renderJornadaDropdown = (games) => { const container=document.getElementById('jornada-dropdown-container'); const uniqueJornadas=[...new Set(games.map(g=>g.jornada))].filter(j=>j!=null); if(uniqueJornadas.length > 0){ const competitionType=currentCompetitionData?.tipo; const specialOrder=['F','1F','MF','QF','1/8','POff']; const getSortPriority=(jornada)=>{ if(isNaN(jornada)){ if(competitionType==='Internacional Clubes' && jornada==='POff'){ return 3; } return 1; } return 2; }; uniqueJornadas.sort((a,b)=>{ const priorityA=getSortPriority(a); const priorityB=getSortPriority(b); if(priorityA!==priorityB){ return priorityA - priorityB; } if(priorityA===1){ return specialOrder.indexOf(a) - specialOrder.indexOf(b); } if(priorityA===2){ return Number(b) - Number(a); } return 0; }); let selectHTML=`<select id="jornada-dropdown">`; uniqueJornadas.forEach(j=>{ const displayText=isNaN(j)? j:`Round ${j}`; selectHTML+=`<option value="${j}">${displayText}</option>`; }); selectHTML+=`</select>`; container.innerHTML=selectHTML; const selector=document.getElementById('jornada-dropdown'); selector.addEventListener('change',e=>{ const value=isNaN(e.target.value)? e.target.value:Number(e.target.value); renderMoreMatchesList(value); }); const initialValue=isNaN(selector.value)? selector.value:Number(selector.value); renderMoreMatchesList(initialValue); document.getElementById('more-matches-section').style.display='block'; } else { container.innerHTML=''; document.getElementById('more-matches-section').style.display='none'; } };
        function parseDate(dateString) { if (!dateString) return new Date(null); if (dateString.includes('-')) { return new Date(dateString); } const parts=dateString.split('/'); if (parts.length===3) { return new Date(parts[2], parts[1] - 1, parts[0]); } return new Date(null); }
        const renderMoreMatchesList = (jornadaNumber) => { const lc=document.getElementById('more-matches-list'); const lm=document.getElementById('more-matches-loading-message'); lc.innerHTML=''; lm.style.display='none'; const fg=gamesOfSeason.filter(g=>String(g.jornada)===String(jornadaNumber)); if(fg.length===0){ lc.innerHTML='<p>No matches found for this round.</p>'; return; } fg.forEach(g=>{ lc.innerHTML+=`<a href="game.html?id=${g.id}" class="match-list-item"><img src="${currentCompetitionData.logoUrl}"><span>${g.nomeJogo}</span></a>`; }); };
        const fetchAndRenderSeasonsDropdown = async (competitionId) => { const c=document.getElementById('seasons-dropdown-container'); const s=await getDocs(collection(db,'temporadas')); const sn=new Set(); s.forEach(d=>sn.add(d.data().nome)); if(sn.size>0){ const sel=document.createElement('select'); sel.id='seasons-dropdown'; Array.from(sn).sort().reverse().forEach(n=>{sel.innerHTML+=`<option value="${n}">${n}</option>`}); c.innerHTML=''; c.appendChild(sel); sel.addEventListener('change',e=>fetchAllGamesForSeason(competitionId, e.target.value)); fetchAllGamesForSeason(competitionId, sel.value); } };
        const fetchAndRenderOtherCompetitions = async (countryId, currentCompId) => { const section=document.getElementById('other-competitions-section'); const gridContainer=document.getElementById('other-competitions-grid'); gridContainer.innerHTML=''; const q=query(collection(db, 'competicoes'), where("paisId", "==", countryId)); const querySnapshot=await getDocs(q); const otherCompetitions=[]; querySnapshot.forEach(doc=>{ if(doc.id!==currentCompId){ otherCompetitions.push({ id: doc.id, ...doc.data() }); } }); if(otherCompetitions.length > 0){ if(currentCompetitionData?.tipo==='Doméstica Liga'){ const typePriority={'Doméstica Liga':1,'Doméstica Taça':2}; otherCompetitions.sort((a,b)=>{ const priorityA=typePriority[a.tipo] || 99; const priorityB=typePriority[b.tipo] || 99; if(priorityA!==priorityB){ return priorityA - priorityB; } return a.nome.localeCompare(b.nome); }); } else { otherCompetitions.sort((a,b)=>a.nome.localeCompare(b.nome)); } otherCompetitions.forEach(comp=>{ gridContainer.innerHTML+=` <a href="competition.html?id=${comp.id}" class="competition-pick-card"> <img src="${comp.logoUrl}" alt="${comp.nome}"> <span>${comp.nome}</span> </a> `; }); section.style.display='block'; } else { section.style.display='none'; } };


        function setupMobileMenu() {
    const menuButton = document.getElementById('menu-toggle-btn');
    const overlay = document.getElementById('page-overlay');
    
    if (menuButton) {
        menuButton.addEventListener('click', () => {
            document.body.classList.toggle('sidebar-open');
        });
    }

    if (overlay) {
        overlay.addEventListener('click', () => {
            document.body.classList.remove('sidebar-open');
        });
    }
}
        
        // --- FUNÇÃO MODIFICADA: initializePage ---
       async function initializePage() {
    console.log("[LOG] A inicializar a página competition.html...");
    const competitionId = new URLSearchParams(window.location.search).get('id');
    console.log(`[LOG] ID da competição obtido da URL: ${competitionId}`);

    if (!competitionId) {
        console.error("[ERRO] Nenhum ID de competição foi fornecido na URL.");
        document.querySelector('.main-content').innerHTML = '<h1>ID da Competição não fornecido.</h1>';
        return;
    }

    await fetchAndStoreClubs();
    const compData = await fetchCompetitionDetails(competitionId);
    
    console.log("[LOG] Resultado da busca pela competição:", compData);

    if (compData) {
        console.log("[LOG] Dados da competição encontrados. A renderizar o resto da página...");
        await fetchAndRenderSeasonsDropdown(competitionId);
        if (compData.paisId) {
            await fetchAndRenderOtherCompetitions(compData.paisId, competitionId);
        }

        // CHAME A FUNÇÃO DO MENU AQUI, NO FINAL
        setupMobileMenu(); 

    } else {
        console.error("[ERRO] A renderização da página foi interrompida porque os dados da competição não foram encontrados.");
    }
}

// --- Iniciar a página ---
initializePage();

    </script>
</body>
</html>
