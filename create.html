<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página de Criação</title>
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.default.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; color: #333; margin: 0; padding: 15px; font-size: 0.9em; padding-top: 60px; }
        #openBulkModalBtn { position: fixed; top: 10px; right: 15px; background-color: #2c3e50; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1001; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease, background-color 0.2s; }
        #openBulkModalBtn:hover { background-color: #34495e; transform: rotate(45deg); }
        .tab-container { width: 100%; max-width: 900px; margin: 0 auto; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        .tab-buttons { display: flex; background-color: #333; }
        .tab-button { padding: 12px 15px; cursor: pointer; border: none; background-color: #333; color: white; font-size: 0.95em; transition: background-color 0.3s; flex-grow: 1; text-align: center; border-right: 1px solid #444; }
        .tab-button:last-child { border-right: none; }
        .tab-button:hover { background-color: #555; }
        .tab-button.active { background-color: #007bff; color: white; }
        .tab-content { padding: 15px; border-top: 1px solid #ddd; display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 12px; display: flex; flex-direction: column; }
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        .form-row .form-group { flex: 1; margin-bottom: 0; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 0.9em; }
        .form-group input[type="text"], .form-group input[type="date"], .form-group input[type="url"], .form-group input[type="number"], .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box; font-size: 0.95em; }
        .form-group select[multiple] { height: 100px; }
        .form-group textarea { min-height: 150px; resize: vertical; }
        .form-group input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        button[type="submit"], .action-btn { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button[type="submit"]:hover, .action-btn:hover { background-color: #218838; }
        button.generate-btn { background-color: #007bff; }
        button.generate-btn:hover { background-color: #0056b3; }
        h3, h4 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .ts-control .item-logo, .ts-dropdown .option-logo { height: 20px; width: 20px; margin-right: 8px; vertical-align: middle; object-fit: contain; }
        .ts-control .item-name, .ts-dropdown .option-name { vertical-align: middle; display: inline-block; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 8px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; }
        #previewPanel { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px; }
        #previewList { max-height: 30vh; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background-color: #f9f9f9; }
        .preview-item { display: flex; align-items: center; padding: 5px; border-bottom: 1px solid #eee; }
        .preview-item:last-child { border-bottom: none; }
        .preview-item input[type="checkbox"] { margin-right: 10px; }
        .preview-item.is-invalid { color: #dc3545; text-decoration: line-through; }
        .preview-item.is-invalid label { cursor: not-allowed; }
        .invalid-reason { font-style: italic; margin-left: auto; font-size: 0.9em; }

        .floating-panel { display: none; position: fixed; top: 80px; right: 20px; z-index: 100; background-color: #fefefe; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.25); padding: 15px; width: 480px; max-width: 90vw; box-sizing: border-box; }
        .floating-panel .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: move; user-select: none; }
        .floating-panel .panel-header h4 { margin: 0; border: none; padding: 0; font-size: 1.1em; }
        #closePreviewBtn { font-size: 24px; font-weight: bold; color: #888; cursor: pointer; line-height: 1; }
        #closePreviewBtn:hover { color: #000; }
        #videoEmbedContainer { position: relative; width: 100%; padding-top: 56.25%; background-color: #000; }
        #videoEmbedContainer iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        .floating-panel .panel-footer { margin-top: 15px; }
        .floating-panel .panel-footer label { display: flex; align-items: center; gap: 8px; font-weight: normal; }
   .input-with-button {
    display: flex;
    align-items: center;
    gap: 5px;
}
.input-with-button input {
    flex-grow: 1;
}
.yt-search-btn {
    flex-shrink: 0;
    width: 45px;
    height: 36px; /* Altura aproximada do input */
    border: none;
    border-radius: 4px;
    background-color: #FF0000;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: background-color 0.2s;
}
.yt-search-btn:hover {
    background-color: #c40303;
}
   

.tom-select-option-container, .tom-select-item-container {
    display: flex;
    align-items: center;
    width: 100%;
}
.option-flag, .item-flag {
    height: 15px;
    width: 20px;
    margin-left: auto;   /* Mantém o alinhamento à direita */
    margin-right: 15px;  /* ADICIONADO: Cria espaço para a scrollbar */
    object-fit: contain;
    vertical-align: middle;
    flex-shrink: 0;      /* ADICIONADO: Impede que a bandeira encolha */
}
.ts-control .item-logo, .ts-dropdown .option-logo {
    flex-shrink: 0; /* Impede que o logo encolha */
}
.ts-control .item-name, .ts-dropdown .option-name {
    flex-grow: 1; /* Permite que o nome cresça para ocupar o espaço */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

   
   </style>
</head>
<body>

    <button id="openBulkModalBtn" title="Criar Múltiplos Jogos">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
    </button>
    
    <div class="tab-container">
       <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab(event, 'criarJogo')">Criar Jogo</button>
            <button class="tab-button" onclick="openTab(event, 'criarJogador')">Criar Jogador</button>
            <button class="tab-button" onclick="openTab(event, 'criarEquipa')">Criar Equipa</button>
            <button class="tab-button" onclick="openTab(event, 'criarCompeticao')">Criar Competição</button>
            <button class="tab-button" onclick="openTab(event, 'criarPais')">Criar País</button>
            <button class="tab-button" onclick="openTab(event, 'criarTemporada')">Criar Temporada</button>
        </div>
        
        <div id="criarJogo" class="tab-content active">
            <h3>Criar Novo Jogo</h3>
            <form id="formCriarJogo">
                 <div class="form-row">
                    <div class="form-group" style="flex: 0.5;"> <label for="jogoGenero">Género:</label> <select id="jogoGenero" name="genero"> <option value="Men" selected>Men</option> <option value="Woman">Woman</option> </select> </div>
                    <div class="form-group" style="flex: 2;"> <label for="jogoCompeticao">Competição:</label> <select id="jogoCompeticao" name="competicaoId" required placeholder="Primeiro, selecione o género..."></select> </div>
                </div>
                <div class="form-row">
                    <div class="form-group"> <label for="jogoEquipaCasa">Equipa da Casa:</label> <select id="jogoEquipaCasa" name="equipaCasaId" required placeholder="Primeiro, selecione a competição..."></select> </div>
                    <div class="form-group"> <label for="jogoEquipaFora">Equipa de Fora:</label> <select id="jogoEquipaFora" name="equipaForaId" required placeholder="Primeiro, selecione a competição..."></select> </div>
                </div>
                <div class="form-row">
                    <div class="form-group"> <label for="jogoResultadoCasa">Resultado Casa:</label> <select id="jogoResultadoCasa" name="resultadoCasa"></select> </div>
                    <div class="form-group"> <label for="jogoResultadoFora">Resultado Fora:</label> <select id="jogoResultadoFora" name="resultadoFora"></select> </div>
                    <div class="form-group"> <label for="jogoResultadoFinal">Resultado Final:</label> <input type="text" id="jogoResultadoFinal" name="resultadoFinal" readonly> </div>
                </div>
                 <div class="form-row">
                    <div class="form-group"> <label for="jogoData">Data do Jogo:</label> <input type="date" id="jogoData" name="dataJogo" required> </div>
                    <div class="form-group"> <label for="jogoTemporada">Temporada:</label> <select id="jogoTemporada" name="temporada" required> <option value="">A carregar...</option> </select> </div>
                    <div class="form-group" style="flex: 0.5;"> <label for="jogoJornada">Jornada:</label> <select id="jogoJornada" name="jornada" required></select> </div>
                </div>
                 <div class="form-group"> <label for="jogoNomeJogo">Nome do Jogo (Automático):</label> 
                     <span id="jogoNomeError" style="color: #dc3545; font-weight: bold; margin-left: 10px; font-size: 0.9em; height: 1em;"></span>
                    <input type="text" id="jogoNomeJogo" name="nomeJogo" readonly> </div>
               
                 <div class="form-group">
    <label for="jogoLinkVideo">Link Vídeo (opcional):</label>
    <div class="input-with-button">
        <input type="url" id="jogoLinkVideo" name="videoUrl" placeholder="https://exemplo.com/video">
        <button type="button" id="searchOnYTBtn" class="yt-search-btn" title="Procurar melhores momentos no YouTube">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
        </button>
    </div>
</div>
              
                <button type="submit" class="action-btn">Criar Jogo</button>
            </form>
        </div>
        <div id="criarJogador" class="tab-content">
            <h3>Criar Novo Jogador</h3>
            <form id="formCriarJogador">
                <div class="form-group"> <label for="jogadorNome">Nome do Jogador:</label> <input type="text" id="jogadorNome" name="nome" required> </div>
                <div class="form-row">
                    <div class="form-group"> <label for="jogadorNacionalidade">Nacionalidade:</label> <select id="jogadorNacionalidade" name="nacionalidadeId" required> <option value="">Selecione...</option> </select> </div>
                    <div class="form-group"> <label for="jogadorPosicao">Posição:</label> <select id="jogadorPosicao" name="posicao" required> <option value="Forward">Forward</option> <option value="Midfielder">Midfielder</option> <option value="Defender">Defender</option> <option value="Goalkeeper">Goalkeeper</option> </select> </div>
                </div>
                <div class="form-row">
                    <div class="form-group"> <label for="jogadorPePreferido">Pé Preferido:</label> <select id="jogadorPePreferido" name="pePreferido"> <option value="Direito" selected>Direito</option> <option value="Esquerdo">Esquerdo</option> </select> </div>
                    <div class="form-group"> <label for="jogadorNascimento">Data de Nascimento:</label> <input type="date" id="jogadorNascimento" name="dataNascimento" required> </div>
                    <div class="form-group"> <label for="jogadorGenero">Género:</label> <select id="jogadorGenero" name="genero"> <option value="Men" selected>Men</option> <option value="Woman">Woman</option> </select> </div>
                </div>
                <div class="form-row">
                    <div class="form-group"> <label for="jogadorAtivo">No Ativo?</label> <select id="jogadorAtivo" name="ativo"> <option value="Yes" selected>Yes</option> <option value="No">No</option> </select> </div>
                    <div class="form-group" style="flex: 2;"> <label for="jogadorImagemCara">Link Imagem Cara (URL):</label> <input type="url" id="jogadorImagemCara" name="imagemCaraUrl" placeholder="https://exemplo.com/imagem.jpg"> </div>
                </div>
                <button type="submit" class="action-btn">Criar Jogador</button>
            </form>
        </div>
        <div id="criarEquipa" class="tab-content">
            <h3>Criar Nova Equipa</h3>
            <form id="formCriarEquipa">
                <div class="form-group">
                    <label for="equipaNome">Nome da Equipa:</label>
                    <span id="equipaNomeError" style="color: #dc3545; font-weight: bold; margin-left: 10px; font-size: 0.9em; height: 1em;"></span>
                    <input type="text" id="equipaNome" name="nome" required>
                </div>
                <div class="form-row">
                    <div class="form-group"> <label for="equipaPais">País:</label> <select id="equipaPais" name="paisId" required> <option value="">Selecione...</option> </select> </div>
                    <div class="form-group"> <label for="equipaTipo">Equipa/Seleção:</label> <select id="equipaTipo" name="tipoEquipa"> <option value="Team" selected>Team</option> <option value="Nacional Team">Nacional Team</option> </select> </div>
                    <div class="form-group"> <label for="equipaGenero">Género:</label> <select id="equipaGenero" name="genero"> <option value="Men" selected>Men</option> <option value="Woman">Woman</option> </select> </div>
                </div>
                <div class="form-group"> <label for="equipaCompeticoes">Competições:</label> <select id="equipaCompeticoes" name="competicoesIds" multiple required> </select> </div>
                <div class="form-group"> <label for="equipaLogoUrl">Link para imagem de logo (URL):</label> <input type="url" id="equipaLogoUrl" name="logoUrl" placeholder="https://exemplo.com/logo.png"> </div>
                <div class="form-row">
                    <div class="form-group"> <label for="equipaEstadio">Estádio (opcional):</label> <input type="text" id="equipaEstadio" name="estadio"> </div>
                    <div class="form-group"> <label for="equipaCapacidade">Capacidade do Estádio (opcional):</label> <input type="number" id="equipaCapacidade" name="capacidadeEstadio" min="0"> </div>
                </div>
                <div class="form-group"> <label for="equipaAlcunha">Alcunha do Clube (opcional):</label> <input type="text" id="equipaAlcunha" name="alcunha"> </div>
                <button type="submit" class="action-btn">Criar Equipa</button>
            </form>
        </div>
        <div id="criarCompeticao" class="tab-content">
            <h3>Criar Nova Competição</h3>
            <form id="formCriarCompeticao">
                <div class="form-group"> <label for="competicaoNome">Nome da Competição:</label> <input type="text" id="competicaoNome" name="nome" required> </div>
                <div class="form-row">
                    <div class="form-group"> <label for="competicaoPais">País:</label> <select id="competicaoPais" name="paisId" required> <option value="">Selecione...</option> </select> </div>
                    <div class="form-group"> <label for="competicaoTipo">Tipo:</label> <select id="competicaoTipo" name="tipo" required> <option value="Doméstica Liga">Doméstica Liga</option> <option value="Doméstica Taça">Doméstica Taça</option> <option value="Internacional Clubes">Internacional Clubes</option> <option value="Internacional Taça">Internacional Taça</option> <option value="Nação Competição">Nação Competição</option> </select> </div>
                </div>
                <div class="form-row">
                    <div class="form-group"> <label for="competicaoEscalao">Escalão:</label> <select id="competicaoEscalao" name="escalao"> <option value="Superior" selected>Superior</option> <option value="Inferior">Inferior</option> </select> </div>
                    <div class="form-group"> <label for="competicaoGenero">Género:</label> <select id="competicaoGenero" name="genero"> <option value="Men" selected>Men</option> <option value="Woman">Woman</option> </select> </div>
                </div>
                <div class="form-row">
                    <div class="form-group"> <label for="competicaoNamming">Namming (opcional):</label> <input type="text" id="competicaoNamming" name="namming"> </div>
                    <div class="form-group"> <label for="competicaoLogoUrl">Link para imagem de logo (URL):</label> <input type="url" id="competicaoLogoUrl" name="logoUrl" placeholder="https://exemplo.com/logo.png"> </div>
                </div>
                <div class="form-row">
                    <div class="form-group"> <label for="competicaoNoMenu">No Menu?</label> <select id="competicaoNoMenu" name="noMenu"> <option value="No" selected>No</option> <option value="Yes">Yes</option> </select> </div>
                    <div class="form-group"> <label for="competicaoPosicaoMenu">Posição no Menu:</label> <input type="number" id="competicaoPosicaoMenu" name="posicaoMenu" min="0"> </div>
                </div>
                <button type="submit" class="action-btn">Criar Competição</button>
            </form>
        </div>
        <div id="criarPais" class="tab-content">
            <h3>Criar Novo País</h3>
             <form id="formCriarPais">
                <div class="form-group"> <label for="paisNome">Nome do País:</label> <input type="text" id="paisNome" name="nome" required> </div>
               <span id="paisNomeError" style="color: #dc3545; font-weight: bold; margin-left: 10px; font-size: 0.9em; height: 1em;"></span>
                <div class="form-row">
                    <div class="form-group"> <label for="paisContinente">Continente:</label> <select id="paisContinente" name="continente" required> <option value="Europe">Europe</option> <option value="Africa">Africa</option> <option value="South America">South America</option> <option value="North America">North America</option> <option value="Asia">Asia</option> <option value="Oceania">Oceania</option>  <option value="World">World</option> </select> </div>
                    <div class="form-group"> <label for="paisBandeiraUrl">Link para imagem de bandeira (URL):</label> <input type="url" id="paisBandeiraUrl" name="bandeiraUrl" placeholder="https://exemplo.com/bandeira.png"> </div>
                </div>
                <button type="submit" class="action-btn">Criar País</button>
            </form>
        </div>
        <div id="criarTemporada" class="tab-content">
            <h3>Criar Nova Temporada</h3>
             <form id="formCriarTemporada">
                <div class="form-group"> <label for="temporadaNome">Nome da Temporada (ex: 2024/2025):</label> <input type="text" id="temporadaNome" name="nome" required placeholder="YYYY/YYYY"> </div>
                <button type="submit" class="action-btn">Criar Temporada</button>
            </form>
        </div>
    </div>

    <div id="bulkCreateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Criar Múltiplos Jogos</h4>
                <span class="close-button" id="closeBulkModalBtn">×</span>
            </div>
            <div id="bulkForm">
                <div class="form-row">
                    <div class="form-group"> <label for="bulkGenero">Género:</label> <select id="bulkGenero" name="genero"> <option value="Men" selected>Men</option> <option value="Woman">Woman</option> </select> </div>
                    <div class="form-group" style="flex:2;"> <label for="bulkCompeticao">Competição:</label> <select id="bulkCompeticao" name="competicaoId" required></select> </div>
                    <div class="form-group"> <label for="bulkTemporada">Temporada:</label> <select id="bulkTemporada" name="temporada" required></select> </div>
                </div>
                <div class="form-group"> <label for="bulkTextData">Cole os dados dos jogos aqui:</label> <textarea id="bulkTextData" placeholder="Exemplo de linha: h2h 2024-08-16 20:00 Man United Man United 1-0 Fulham Fulham J1"></textarea> </div>
                <button id="generateGamesBtn" class="action-btn generate-btn">Gerar Lista de Jogos</button>
            </div>
            <div id="previewPanel" style="display:none;">
                <h4>Jogos a serem criados</h4>
                <p>Confirme a lista abaixo. Jogos marcados a vermelho já existem ou contêm erros e não serão criados.</p>
                <div id="previewList"></div>
                <div style="margin-top: 15px; text-align: right;"> <button id="createGamesBtn" class="action-btn">Criar Jogos Selecionados</button> </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, doc, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBa6zi1FV_WFkatQW-w2vb_votXJ43p76o", authDomain: "varsoccer-26040.firebaseapp.com", projectId: "varsoccer-26040", storageBucket: "varsoccer-26040.firebasestorage.app", messagingSenderId: "11877829810", appId: "1:11877829810:web:98f9baa131a3b88b6e8dab" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let allCompetitions = [], allClubs = [], allSeasons = [], allPaises = [];
        let tsBulkCompeticao, tsJogoCompeticao, tsJogoEquipaCasa, tsJogoEquipaFora, tsEquipaCompeticoes;
        let isInitialized = false;

        const renderWithLogo = {
    option: (data, escape) => {
        const pais = data.paisId ? allPaises.find(p => p.id === data.paisId) : null;
        const bandeiraUrl = pais ? pais.bandeiraUrl : '';
        const flagHtml = bandeiraUrl ? `<img class="option-flag" src="${escape(bandeiraUrl)}" alt="Bandeira">` : '';

        return `<div class="tom-select-option-container">
                    <img class="option-logo" src="${escape(data.logoUrl || 'https://via.placeholder.com/20')}" alt="Logo">
                    <span class="option-name">${escape(data.nome)}</span>
                    ${flagHtml}
                </div>`;
    },
    item: (data, escape) => {
        const pais = data.paisId ? allPaises.find(p => p.id === data.paisId) : null;
        const bandeiraUrl = pais ? pais.bandeiraUrl : '';
        const flagHtml = bandeiraUrl ? `<img class="item-flag" src="${escape(bandeiraUrl)}" alt="Bandeira">` : '';

        return `<div class="tom-select-item-container">
                    <img class="item-logo" src="${escape(data.logoUrl || 'https://via.placeholder.com/20')}" alt="Logo">
                    <span class="item-name">${escape(data.nome)}</span>
                    ${flagHtml}
                </div>`;
    }
};

        window.openTab = (event, tabName) => {
            document.querySelectorAll(".tab-content").forEach(tc => { tc.style.display = "none"; tc.classList.remove("active"); });
            document.querySelectorAll(".tab-button").forEach(tb => tb.classList.remove("active"));
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            event.currentTarget.classList.add("active");
        };

        const singleGameElements = {
            genero: document.getElementById('jogoGenero'),
            competicao: document.getElementById('jogoCompeticao'),
            equipaCasa: document.getElementById('jogoEquipaCasa'),
            equipaFora: document.getElementById('jogoEquipaFora'),
            resCasa: document.getElementById('jogoResultadoCasa'),
            resFora: document.getElementById('jogoResultadoFora'),
            resFinal: document.getElementById('jogoResultadoFinal'),
            data: document.getElementById('jogoData'),
            temporada: document.getElementById('jogoTemporada'),
            jornada: document.getElementById('jogoJornada'),
            nomeJogo: document.getElementById('jogoNomeJogo')
        };
        const bulkModalElements = {
            modal: document.getElementById('bulkCreateModal'),
            openBtn: document.getElementById('openBulkModalBtn'),
            closeBtn: document.getElementById('closeBulkModalBtn'),
            generateBtn: document.getElementById('generateGamesBtn'),
            createBtn: document.getElementById('createGamesBtn'),
            panel: document.getElementById('previewPanel'),
            list: document.getElementById('previewList'),
            genero: document.getElementById('bulkGenero'),
            competicao: document.getElementById('bulkCompeticao'),
            temporada: document.getElementById('bulkTemporada'),
            text: document.getElementById('bulkTextData')
        };

        bulkModalElements.openBtn.onclick = () => bulkModalElements.modal.style.display = 'block';
        bulkModalElements.closeBtn.onclick = () => bulkModalElements.modal.style.display = 'none';
        window.onclick = (event) => { if (event.target == bulkModalElements.modal) bulkModalElements.modal.style.display = 'none'; };
        
        function populateBulkModalDropdowns() {
            const { temporada, genero } = bulkModalElements;
            temporada.innerHTML = '';
            allSeasons.forEach(s => { temporada.innerHTML += `<option value="${s.nome}">${s.nome}</option>`; });
            if (temporada.options.length > 0) temporada.selectedIndex = 0;
            if(tsBulkCompeticao) {
                const filteredComps = allCompetitions.filter(c => c.genero === genero.value);
                tsBulkCompeticao.clear();
                tsBulkCompeticao.clearOptions();
                tsBulkCompeticao.addOptions(filteredComps);
            }
        }
        
        function findTeamByName(name) { return allClubs.find(c => c.nome.toLowerCase() === name.trim().toLowerCase()) || null; }

 // Substitua a função original por esta versão melhorada
  bulkModalElements.generateBtn.addEventListener('click', async () => {
    const { text, generateBtn } = bulkModalElements;
    const rawText = text.value;

    if (!rawText.trim()) { alert("Por favor, cole os dados dos jogos."); return; }
    
    const competicaoId = tsBulkCompeticao.getValue();
    const temporada = bulkModalElements.temporada.value;
    const genero = bulkModalElements.genero.value;

    if (!competicaoId) { alert("Por favor, selecione uma competição."); return; }

    // Desativa o botão e mostra feedback ao utilizador
    generateBtn.disabled = true;
    generateBtn.textContent = 'A consultar a base de dados...';

    try {
        // PASSO 1: Consultar o Firebase para obter a contagem de jogos existentes
        const teamGameCounts = new Map();
        const q = query(
            collection(db, "jogos"),
            where("competicaoId", "==", competicaoId),
            where("temporada", "==", temporada),
            where("genero", "==", genero)
        );

        const querySnapshot = await getDocs(q);
        querySnapshot.forEach(doc => {
            const game = doc.data();
            const casa = game.equipaCasaNome;
            const fora = game.equipaForaNome;
            // Popula o contador com os jogos já existentes
            teamGameCounts.set(casa, (teamGameCounts.get(casa) || 0) + 1);
            teamGameCounts.set(fora, (teamGameCounts.get(fora) || 0) + 1);
        });
        
        generateBtn.textContent = 'A gerar lista...';

        // PASSO 2: Processar o texto colado, usando o contador pré-populado
        let gameCandidates = [];
        const regexWithVs = /(\d{4}-\d{2}-\d{2})(?:\s+\d{2}:\d{2})?\s+(.+?)\s+\2\s+vs\s+(.+?)\s+\3\s+(J\d+|POff|F|1\/8|QF|MF|1F|[1-3]PE|C)/i;
        const regexWithScore = /(\d{4}-\d{2}-\d{2})(?:\s+\d{2}:\d{2})?\s+(.+?)\s+\2\s+(\d+-\d+)\s+(.+?)\s+\4\s+(J\d+|POff|F|1\/8|QF|MF|1F|[1-3]PE|C)/i;
        
        const gameBlocks = rawText.split(/h2h/i).filter(block => block.trim() !== '');

        for (const block of gameBlocks) {
            const singleLineBlock = block.replace(/\n/g, ' ').trim();
            let match;
            let gameData = {};

            match = singleLineBlock.match(regexWithVs);
            if (match) {
                gameData = { dataJogo: match[1], equipaCasaNome: match[2].trim(), equipaForaNome: match[3].trim(), jornadaBruta: match[4], resultadoCasa: null, resultadoFora: null };
            } else {
                match = singleLineBlock.match(regexWithScore);
                if (match) {
                    const [resCasa, resFora] = match[3].split('-');
                    gameData = { dataJogo: match[1], equipaCasaNome: match[2].trim(), resultadoCasa: resCasa, resultadoFora: resFora, equipaForaNome: match[4].trim(), jornadaBruta: match[5] };
                }
            }
            
            if (match) {
                let jornadaFinal;
                if (gameData.jornadaBruta && gameData.jornadaBruta.toUpperCase() === 'C') {
                    // A contagem agora parte dos valores obtidos do Firebase
                    const currentCountCasa = teamGameCounts.get(gameData.equipaCasaNome) || 0;
                    const currentCountFora = teamGameCounts.get(gameData.equipaForaNome) || 0;
                    const newCount = Math.max(currentCountCasa, currentCountFora) + 1;
                    jornadaFinal = newCount;
                    teamGameCounts.set(gameData.equipaCasaNome, newCount);
                    teamGameCounts.set(gameData.equipaForaNome, newCount);
                } else {
                     jornadaFinal = (gameData.jornadaBruta && gameData.jornadaBruta.toUpperCase().startsWith('J')) ? gameData.jornadaBruta.substring(1) : gameData.jornadaBruta;
                }
                gameCandidates.push({ ...gameData, jornada: jornadaFinal });
            } else if (singleLineBlock) {
                 console.warn("Linha não reconhecida e ignorada:", singleLineBlock);
            }
        }

        // PASSO 3: Resolução de ambiguidades e exibição da pré-visualização (sem alterações)
        const ambiguities = new Map();
        const resolvedChoices = new Map();
        const findClubMatches = (name) => allClubs.filter(c => c.nome.toLowerCase() === name.trim().toLowerCase());

        for (const candidate of gameCandidates) {
            [candidate.equipaCasaNome, candidate.equipaForaNome].forEach(name => {
                if (resolvedChoices.has(name) || ambiguities.has(name)) return;
                const matches = findClubMatches(name);
                if (matches.length > 1) {
                    ambiguities.set(name, matches);
                } else if (matches.length === 1) {
                    resolvedChoices.set(name, matches[0].id);
                }
            });
        }

        if (ambiguities.size > 0) {
            await resolveNextAmbiguity(ambiguities, resolvedChoices, gameCandidates);
        } else {
            buildFinalPreviewList(gameCandidates, resolvedChoices);
        }

    } catch (error) {
        console.error("Erro ao gerar lista de jogos:", error);
        alert("Ocorreu um erro ao comunicar com a base de dados: " + error.message);
    } finally {
        // Reativa o botão e restaura o texto original, independentemente do resultado
        generateBtn.disabled = false;
        generateBtn.textContent = 'Gerar Lista de Jogos';
    }
});




// FUNÇÃO NOVA: Constrói a lista final de pré-visualização
           async function buildFinalPreviewList(gameCandidates, resolvedChoices) {
            const { list, panel } = bulkModalElements;
            let nameCheckList = new Set();
            
            // Adiciona IDs e valida os candidatos
            gameCandidates.forEach(candidate => {
                const homeId = resolvedChoices.get(candidate.equipaCasaNome);
                const awayId = resolvedChoices.get(candidate.equipaForaNome);

                candidate.equipaCasaId = homeId || null;
                candidate.equipaForaId = awayId || null;
                candidate.isValid = !!(homeId && awayId);

                if (!candidate.isValid) {
                    candidate.invalidReason = !homeId ? `Equipa "${candidate.equipaCasaNome}" não encontrada.` : `Equipa "${candidate.equipaForaNome}" não encontrada.`;
                }
                
                const [y,m,d] = candidate.dataJogo.split('-');
                const resultadoFinal = candidate.resultadoCasa !== null ? `${candidate.resultadoCasa}-${candidate.resultadoFora}` : 'X';
                candidate.nomeJogo = `${candidate.equipaCasaNome} ${resultadoFinal} ${candidate.equipaForaNome} - ${d}/${m}/${y}`;
                if (candidate.isValid) nameCheckList.add(candidate.nomeJogo);
            });
            
            // Verifica jogos existentes no DB
            const existingGames = new Set();
            if (nameCheckList.size > 0) {
                const namesToQuery = Array.from(nameCheckList);
                const chunks = [];
                for (let i = 0; i < namesToQuery.length; i += 30) chunks.push(namesToQuery.slice(i, i + 30));
                const queryPromises = chunks.map(chunk => getDocs(query(collection(db, "jogos"), where("nomeJogo", "in", chunk))));
                const querySnapshots = await Promise.all(queryPromises);
                querySnapshots.forEach(snapshot => snapshot.forEach(doc => existingGames.add(doc.data().nomeJogo)));
            }
    
            // --- INÍCIO DA ALTERAÇÃO ---
            const processedInThisBatch = new Set(); // Regista os jogos únicos deste lote
            // --- FIM DA ALTERAÇÃO ---

            // Popula a lista na UI
            list.innerHTML = '';
            gameCandidates.forEach((game, index) => {
                let isInvalid = !game.isValid;
                let invalidReason = game.invalidReason;

                // Apenas faz validações de duplicados se o jogo for estruturalmente válido
                if (game.isValid) {
                    if (existingGames.has(game.nomeJogo)) {
                        isInvalid = true;
                        invalidReason = 'Jogo já existe no DB.';
                    // --- INÍCIO DA ALTERAÇÃO ---
                    } else if (processedInThisBatch.has(game.nomeJogo)) {
                        // Se o jogo já foi processado neste lote, marca como inválido
                        isInvalid = true;
                        invalidReason = 'Duplicado nesta lista.';
                    } else {
                        // Se for a primeira vez, adiciona ao registo para deteção futura
                        processedInThisBatch.add(game.nomeJogo);
                    }
                    // --- FIM DA ALTERAÇÃO ---
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = 'preview-item' + (isInvalid ? ' is-invalid' : '');
                itemDiv.innerHTML = `<input type="checkbox" id="game-check-${index}" data-index="${index}" ${isInvalid ? 'disabled' : 'checked'}><label for="game-check-${index}">${game.nomeJogo}</label>${isInvalid ? `<span class="invalid-reason">${invalidReason}</span>` : ''}`;
                list.appendChild(itemDiv);
            });
            window.gameCandidates = gameCandidates;
            panel.style.display = 'block';
        }





         // FUNÇÃO NOVA: Gere o processo de resolução de ambiguidades
        function resolveNextAmbiguity(ambiguities, resolvedChoices, gameCandidates) {
            return new Promise(resolve => {
                if (ambiguities.size === 0) {
                    // Todas resolvidas, constrói a lista final
                    buildFinalPreviewList(gameCandidates, resolvedChoices);
                    resolve();
                    return;
                }


 const [name, clubs] = ambiguities.entries().next().value;
                const modal = document.getElementById('disambiguationModal');
                const nameHolder = document.getElementById('ambiguousClubName');
                const optionsContainer = document.getElementById('disambiguationOptions');
                const confirmBtn = document.getElementById('confirmDisambiguationBtn');
                
                nameHolder.textContent = name;
                optionsContainer.innerHTML = '';

                clubs.forEach(club => {
                    const pais = allPaises.find(p => p.id === club.paisId);
                    const paisNome = pais ? pais.nome : 'País não definido';
                    const optionHTML = `
                        <label style="display: flex; align-items: center; padding: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                            <input type="radio" name="club-choice" value="${club.id}" style="margin-right: 15px;">
                            <img src="${club.logoUrl || 'https://via.placeholder.com/20'}" style="width: 20px; height: 20px; margin-right: 10px; object-fit: contain;">
                            <span style="flex-grow: 1;">${club.nome}</span>
                            <strong style="margin-left: 10px;">${paisNome}</strong>
                        </label>
                    `;
                    optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
                });

                const onConfirm = () => {
                    const selected = optionsContainer.querySelector('input:checked');
                    if (selected) {
                        resolvedChoices.set(name, selected.value); // Guarda a escolha
                        ambiguities.delete(name); // Remove da lista de ambiguidades
                        modal.style.display = 'none';
                        confirmBtn.removeEventListener('click', onConfirm); // Limpa o listener
                        resolve(resolveNextAmbiguity(ambiguities, resolvedChoices, gameCandidates)); // Chama recursivamente para o próximo
                    } else {
                        alert("Por favor, selecione uma equipa.");
                    }
                };

                confirmBtn.addEventListener('click', onConfirm);
                modal.style.display = 'block';
            });
        }

  const equipaNomeInput = document.getElementById('equipaNome');
    const equipaNomeErrorSpan = document.getElementById('equipaNomeError');
    const equipaSubmitBtn = document.querySelector('#formCriarEquipa button[type="submit"]');

    equipaNomeInput.addEventListener('input', (e) => {
        const nomeAtual = e.target.value.trim().toLowerCase();
        // Limpa o aviso se o campo estiver vazio
        if (nomeAtual === '') {
            equipaNomeErrorSpan.textContent = '';
            equipaSubmitBtn.disabled = false;
            return;
        }
        // Verifica se a equipa já existe na lista `allClubs`
        const existe = allClubs.some(club => club.nome.toLowerCase() === nomeAtual);
        
        if (existe) {
            equipaNomeErrorSpan.textContent = 'Este clube já existe!';
            equipaSubmitBtn.disabled = true; // Desativa o botão de criar
        } else {
            equipaNomeErrorSpan.textContent = '';
            equipaSubmitBtn.disabled = false; // Ativa o botão de criar
        }
    });



        bulkModalElements.createBtn.addEventListener('click', async () => {
            const { createBtn, modal, panel, text } = bulkModalElements;
            const selectedIndices = Array.from(document.querySelectorAll('#previewList input:checked')).map(cb => parseInt(cb.dataset.index));
            if (selectedIndices.length === 0) { alert("Nenhum jogo válido selecionado."); return; }

            createBtn.disabled = true;
            createBtn.textContent = `A criar ${selectedIndices.length}...`;
            const batch = writeBatch(db);
            const competicaoData = tsBulkCompeticao.options[tsBulkCompeticao.getValue()];

            selectedIndices.forEach(index => {
                const game = window.gameCandidates[index];
                const gameData = {
                    genero: bulkModalElements.genero.value, competicaoId: competicaoData.id, competicaoNome: competicaoData.nome,
                    temporada: bulkModalElements.temporada.value, equipaCasaId: game.equipaCasaId, equipaForaId: game.equipaForaId,
                    equipaCasaNome: game.equipaCasaNome, equipaForaNome: game.equipaForaNome, resultadoCasa: game.resultadoCasa,
                    resultadoFora: game.resultadoFora, resultadoFinal: game.resultadoCasa !== null ? `${game.resultadoCasa}-${game.resultadoFora}` : 'X',
                    dataJogo: game.dataJogo, jornada: game.jornada, nomeJogo: game.nomeJogo, videoUrl: '',
                };
                batch.set(doc(collection(db, "jogos")), gameData);
            });

            try {
                await batch.commit();
                alert(`${selectedIndices.length} jogos criados!`);
                modal.style.display = 'none'; panel.style.display = 'none'; text.value = '';
            } catch (error) { console.error("Erro em lote: ", error); alert("Erro: " + error.message); }
            finally { createBtn.disabled = false; createBtn.textContent = 'Criar Jogos Selecionados'; }
        });

        const videoLinkInput = document.getElementById('jogoLinkVideo');
        const previewPanel = document.getElementById('videoPreviewPanel');
        const embedContainer = document.getElementById('videoEmbedContainer');
        const closePreviewBtn = document.getElementById('closePreviewBtn');
        const panelHeader = previewPanel.querySelector('.panel-header');

        function getYouTubeEmbedUrl(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? `https://www.youtube.com/embed/${match[2]}` : null;
        }

        videoLinkInput.addEventListener('input', () => {
            const url = videoLinkInput.value;
            const embedUrl = getYouTubeEmbedUrl(url);
            if (embedUrl) {
                embedContainer.innerHTML = `<iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                previewPanel.style.display = 'block';
            } else {
                previewPanel.style.display = 'none';
            }
        });

        const hidePanel = () => { 
            previewPanel.style.display = 'none';
            embedContainer.innerHTML = '';
        };
        closePreviewBtn.addEventListener('click', hidePanel);

        let isDragging = false;
        let offsetX, offsetY;

        panelHeader.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - previewPanel.getBoundingClientRect().left;
            offsetY = e.clientY - previewPanel.getBoundingClientRect().top;
            
            previewPanel.style.right = 'auto';
            previewPanel.style.bottom = 'auto';
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });

        function onMouseMove(e) {
            if (!isDragging) return;
            const newLeft = e.clientX - offsetX;
            const newTop = e.clientY - offsetY;
            previewPanel.style.left = `${newLeft}px`;
            previewPanel.style.top = `${newTop}px`;
        }

        function onMouseUp() {
            isDragging = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

   document.getElementById('formCriarJogo').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = this;
    const data = Object.fromEntries(new FormData(form).entries());

    // --- VERIFICAÇÃO FINAL ANTES DE GRAVAR ---
    const { nomeJogo, dataJogo, equipaCasaId, equipaForaId } = data;

    if (equipaCasaId === equipaForaId) {
        alert("Erro: As equipas da casa e de fora não podem ser as mesmas.");
        return;
    }

    // Query 1: Nome exato
     const qNome = query(collection(db, "jogos"), where("nomeJogo", "==", nomeJogo));
    const qCombinacao1 = query(collection(db, "jogos"), 
        where("dataJogo", "==", dataJogo),
        where("equipaCasaId", "==", equipaCasaId),
        where("equipaForaId", "==", equipaForaId)
    );
    const qCombinacao2 = query(collection(db, "jogos"), 
        where("dataJogo", "==", dataJogo),
        where("equipaCasaId", "==", equipaForaId),
        where("equipaForaId", "==", equipaCasaId)
    );

    
   const [snapNome, snapCombinacao1, snapCombinacao2] = await Promise.all([
        getDocs(qNome), getDocs(qCombinacao1), getDocs(qCombinacao2)
    ]);

    if (!snapNome.empty || !snapCombinacao1.empty || !snapCombinacao2.empty) {
        alert("Erro: O jogo que está a tentar criar já existe (mesmas equipas na mesma data).");
        return;
    }

    // --- FIM DA VERIFICAÇÃO ---
    
    data.competicaoNome = tsJogoCompeticao.options[data.competicaoId]?.nome;
    data.equipaCasaNome = tsJogoEquipaCasa.options[data.equipaCasaId]?.nome;
    data.equipaForaNome = tsJogoEquipaFora.options[data.equipaForaId]?.nome;

   const useLinkOnly = document.getElementById('useLinkOnlyCheckbox').checked;
    if (data.videoUrl && useLinkOnly) {
        data.apiYt = true;
    }

 try {
        // 1. Grava os dados no Firebase
        await addDoc(collection(db, "jogos"), data);

        // 2. Avisa o utilizador que foi um sucesso
        alert("Jogo criado!");
        
        // 3. Recarrega a página. Fim do processo.
        location.reload(); 

    } catch (err) {
        alert("Erro: " + err.message);
    }
});

        document.getElementById('formCriarJogador').addEventListener('submit', async function(e) { e.preventDefault(); try { await addDoc(collection(db, "jogadores"), Object.fromEntries(new FormData(this).entries())); alert("Jogador criado!"); this.reset(); } catch(err){ alert("Erro: "+err.message); }});
        
     document.getElementById('formCriarEquipa').addEventListener('submit', async function(e) {
    e.preventDefault();
    const fd = new FormData(this);
    const d = Object.fromEntries(fd.entries());
    const nomeEquipaParaVerificar = d.nome.trim().toLowerCase();
    const errorSpan = document.getElementById('equipaNomeError');
    const existe = allClubs.some(club => club.nome.toLowerCase() === nomeEquipaParaVerificar);

    if (existe) {
        errorSpan.textContent = "Este clube já existe na base de dados!";
        return;
    }

     d.competicoesIds = fd.getAll('competicoesIds');
    const preSeasonCompetition = allCompetitions.find(comp => comp.nome && comp.nome.trim().toLowerCase() === 'pre season');
    if (preSeasonCompetition && !d.competicoesIds.includes(preSeasonCompetition.id)) {
        d.competicoesIds.push(preSeasonCompetition.id);
    }

   try {
        await addDoc(collection(db, "clubes"), d);
        // O alerta foi removido daqui.
        this.reset();
        errorSpan.textContent = '';
        fetchAllInitialData(); 
    } catch(err){
        alert("Erro: "+err.message);
    }
});

      document.getElementById('formCriarCompeticao').addEventListener('submit', async function(e) {
    e.preventDefault(); 
    const d = Object.fromEntries(new FormData(this).entries()); 
    
    // ESTA É A LÓGICA IMPORTANTE
    if(d.posicaoMenu) {
        // Se houver um valor, converte para número
        d.posicaoMenu = parseInt(d.posicaoMenu); 
    } else {
        // Se estiver vazio, remove a propriedade antes de gravar
        delete d.posicaoMenu; 
    }

    try { 
        await addDoc(collection(db, "competicoes"), d); 
        alert("Competição criada!"); 
        this.reset(); 
        fetchAllInitialData(); 
    } catch(err){ 
        alert("Erro: "+err.message); 
    }
});
        document.getElementById('formCriarTemporada').addEventListener('submit', async function(e) { e.preventDefault(); try { await addDoc(collection(db, "temporadas"), Object.fromEntries(new FormData(this).entries())); alert("Temporada criada!"); this.reset(); fetchAllInitialData(); } catch(err){ alert("Erro: "+err.message); }});

        function populateCompetitionsForJogo() {
            if (!tsJogoCompeticao) return;
            const filtered = allCompetitions.filter(c => c.genero === singleGameElements.genero.value);
            tsJogoCompeticao.clear(); tsJogoCompeticao.clearOptions(); tsJogoCompeticao.addOptions(filtered);
            resetEquipasDropdowns();
        }
      function populateEquipasForJogo() {
    if (!tsJogoEquipaCasa) return;
    
    // Filtra equipas apenas pelo GÉNERO selecionado
    const filtered = allClubs.filter(c => c.genero === singleGameElements.genero.value);
    
    const casaVal = tsJogoEquipaCasa.getValue();
    const foraVal = tsJogoEquipaFora.getValue();
    
    tsJogoEquipaCasa.clear();
    tsJogoEquipaCasa.clearOptions();
    tsJogoEquipaCasa.addOptions(filtered);
    
    tsJogoEquipaFora.clear();
    tsJogoEquipaFora.clearOptions();
    tsJogoEquipaFora.addOptions(filtered);
    
    // Tenta reaplicar os valores selecionados anteriormente se ainda forem válidos
    if(filtered.some(c => c.id === casaVal)) tsJogoEquipaCasa.setValue(casaVal, true);
    if(filtered.some(c => c.id === foraVal)) tsJogoEquipaFora.setValue(foraVal, true);
}

        function resetEquipasDropdowns() { if(tsJogoEquipaCasa) { tsJogoEquipaCasa.clear(); tsJogoEquipaCasa.clearOptions(); tsJogoEquipaFora.clear(); tsJogoEquipaFora.clearOptions(); } }
function updateResultadoFinal() {
    const resCasaVal = singleGameElements.resCasa.value;
    const resForaVal = singleGameElements.resFora.value;

    // Verifica se ambos os valores são strings não vazias (o que inclui "0")
    if (resCasaVal !== '' && resForaVal !== '') {
        singleGameElements.resFinal.value = `${resCasaVal}-${resForaVal}`;
    } else {
        // Se um deles não for selecionado, o resultado final fica vazio
        singleGameElements.resFinal.value = '';
    }
    
    // Chama a atualização do nome do jogo, que agora terá o valor correto (ex: "0-0")
    updateNomeJogo();
}

       async function updateNomeJogo() {
            if (!tsJogoEquipaCasa || !tsJogoEquipaCasa.options) return;
            const { nomeJogo, data } = singleGameElements;
            const casaId = tsJogoEquipaCasa.getValue(), foraId = tsJogoEquipaFora.getValue();
            
            const errorSpan = document.getElementById('jogoNomeError');
            const submitBtn = document.querySelector('#formCriarJogo button[type="submit"]');

            if(!casaId || !foraId || !data.value || casaId === foraId) {
                nomeJogo.value = '';
                errorSpan.textContent = (casaId && foraId && casaId === foraId) ? "As equipas devem ser diferentes." : "";
                submitBtn.disabled = (casaId === foraId);
                return;
            }
            
            const casaNome = tsJogoEquipaCasa.options[casaId]?.nome;
            const foraNome = tsJogoEquipaFora.options[foraId]?.nome;
            if(!casaNome || !foraNome) return;
            
            const hoje = new Date(); 
            hoje.setHours(0,0,0,0);
            
            // --- LINHA MODIFICADA ---
            const resultado = new Date(data.value + 'T00:00:00') > hoje ? 'X' : singleGameElements.resFinal.value;
            // --- FIM DA MODIFICAÇÃO ---
            
            const [y,m,d] = data.value.split('-');
            const nomeJogoCalculado = `${casaNome} ${resultado} ${foraNome} - ${d}/${m}/${y}`;
            nomeJogo.value = nomeJogoCalculado;

            // --- LÓGICA DE VERIFICAÇÃO AVANÇADA ---
            let gameExists = false;
            let errorMessage = "";
            const dataJogo = data.value;

            // Query 1: Verifica o nome exato do jogo
            const qNome = query(collection(db, "jogos"), where("nomeJogo", "==", nomeJogoCalculado));
            
            // Query 2: Verifica Casa vs Fora na mesma data
            const qCombinacao1 = query(collection(db, "jogos"), 
                where("dataJogo", "==", dataJogo),
                where("equipaCasaId", "==", casaId),
                where("equipaForaId", "==", foraId)
            );

            // Query 3: Verifica Fora vs Casa na mesma data
            const qCombinacao2 = query(collection(db, "jogos"), 
                where("dataJogo", "==", dataJogo),
                where("equipaCasaId", "==", foraId), // Invertido
                where("equipaForaId", "==", casaId)  // Invertido
            );

            // Executa todas as consultas em paralelo para eficiência
            const [snapNome, snapCombinacao1, snapCombinacao2] = await Promise.all([
                getDocs(qNome),
                getDocs(qCombinacao1),
                getDocs(qCombinacao2)
            ]);

            if (!snapNome.empty) {
                gameExists = true;
                errorMessage = "Este jogo (nome exato) já existe!";
            } else if (!snapCombinacao1.empty || !snapCombinacao2.empty) {
                gameExists = true;
                errorMessage = "Já existe um jogo entre estas duas equipas nesta data.";
            }

            // Atualiza a UI com o resultado
            if (gameExists) {
                errorSpan.textContent = errorMessage;
                submitBtn.disabled = true;
            } else {
                errorSpan.textContent = "";
                submitBtn.disabled = false;
            }
        }
        
 async function calculateNextJornada() {
    if (!tsJogoEquipaCasa) return;
    const { jornada, temporada } = singleGameElements;
    const equipaId = tsJogoEquipaCasa.getValue();
    const compId = tsJogoCompeticao.getValue();
    
    if (!equipaId || !temporada.value || !compId) return;

    // Consulta para jogos em casa
    const qCasa = query(collection(db, "jogos"), 
        where("equipaCasaId", "==", equipaId), 
        where("temporada", "==", temporada.value), 
        where("competicaoId", "==", compId)
    );
    // Consulta para jogos fora
    const qFora = query(collection(db, "jogos"), 
        where("equipaForaId", "==", equipaId), 
        where("temporada", "==", temporada.value), 
        where("competicaoId", "==", compId)
    );

    const [snapCasa, snapFora] = await Promise.all([
        getDocs(qCasa),
        getDocs(qFora)
    ]);
    
    let maxJornada = 0;
    
    // Processa os resultados de ambas as consultas
    const processarResultados = (querySnapshot) => {
        querySnapshot.forEach(doc => {
            const jValue = parseInt(doc.data().jornada);
            if (!isNaN(jValue) && jValue > maxJornada) {
                maxJornada = jValue;
            }
        });
    };
    
    processarResultados(snapCasa);
    processarResultados(snapFora);

    // --- BLOCO DE LÓGICA ALTERADO ---
    if (maxJornada > 0 && maxJornada < 60) { // Alterado de 40 para 60
        jornada.value = maxJornada + 1;
    } else if (maxJornada >= 60) {           // Alterado de 40 para 60
        jornada.value = 60; // Mantém em 60 se já for o máximo
    } else {
        jornada.value = 1; // Padrão se não houver jornadas numéricas
    }
    // --- FIM DA ALTERAÇÃO ---
}

   function setupEventListeners() {
        // Listeners originais
        bulkModalElements.genero.addEventListener('change', populateBulkModalDropdowns);
        
        singleGameElements.genero.addEventListener('change', () => {
            populateCompetitionsForJogo();
            populateEquipasForJogo();
        });

        tsJogoCompeticao.on('change', () => { 
            calculateNextJornada(); 
        });

        tsJogoEquipaCasa.on('change', updateNomeJogo);
        tsJogoEquipaFora.on('change', updateNomeJogo);
        singleGameElements.data.addEventListener('change', updateNomeJogo);
        singleGameElements.resCasa.addEventListener('change', updateResultadoFinal);
        singleGameElements.resFora.addEventListener('change', updateResultadoFinal);
        tsJogoEquipaCasa.on('change', calculateNextJornada);
        singleGameElements.temporada.addEventListener('change', calculateNextJornada);

        document.getElementById('searchOnYTBtn').addEventListener('click', function() {
            const gameName = document.getElementById('jogoNomeJogo').value;
            if (gameName.trim()) {
                const searchTerm = gameName.split(' - ')[0] + ' highlights';
                const youtubeUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(searchTerm)}`;
                window.open(youtubeUrl, '_blank');
            } else {
                alert('O nome do jogo precisa ser gerado primeiro para fazer a pesquisa.');
            }
        });

        // --- INÍCIO DA CORREÇÃO ---
        // Adiciona os listeners para todos os formulários de criação
        
        document.getElementById('formCriarJogo').addEventListener('submit', async function(e) {
            // ... (A lógica do formCriarJogo que já existe no seu código)
        });
        document.getElementById('formCriarJogador').addEventListener('submit', async function(e) { 
            // ... (A lógica do formCriarJogador que já existe)
        });
        document.getElementById('formCriarEquipa').addEventListener('submit', async function(e) {
            // ... (A lógica do formCriarEquipa que já existe)
        });
        document.getElementById('formCriarCompeticao').addEventListener('submit', async function(e) {
            // ... (A lógica do formCriarCompeticao que já existe)
        });

        // OUVINTE QUE ESTAVA EM FALTA
        document.getElementById('formCriarPais').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = this;
            const d = Object.fromEntries(new FormData(form).entries());
            const nomePaisParaVerificar = d.nome.trim().toLowerCase();
            
            const existe = allPaises.some(pais => pais.nome.toLowerCase() === nomePaisParaVerificar);

            if (existe) {
                alert("Este país já existe na base de dados!");
                return; // Impede o envio do formulário
            }

            try {
                await addDoc(collection(db, "paises"), d);
                alert("País criado!");
                form.reset();
                document.getElementById('paisNomeError').textContent = ''; 
                await fetchAllInitialData(); // Atualiza a lista de países
            } catch(err) {
                alert("Erro: " + err.message);
            }
        });

        document.getElementById('formCriarTemporada').addEventListener('submit', async function(e) {
            // ... (A lógica do formCriarTemporada que já existe)
        });
        // --- FIM DA CORREÇÃO ---
    }

      async function fetchAllInitialData() {
            try {
                const snaps = await Promise.all([ getDocs(query(collection(db, "paises"), orderBy("nome"))), getDocs(query(collection(db, "competicoes"), orderBy("nome"))), getDocs(query(collection(db, "clubes"), orderBy("nome"))), getDocs(query(collection(db, "temporadas"), orderBy("nome", "desc"))) ]);
                allPaises = snaps[0].docs.map(d => ({id:d.id, ...d.data()}));
                allCompetitions = snaps[1].docs.map(d => ({id:d.id, ...d.data()}));
                allClubs = snaps[2].docs.map(d => ({id:d.id, ...d.data()}));
                allSeasons = snaps[3].docs.map(d => ({id:d.id, ...d.data()}));
                
                if (!isInitialized) {
                    const singleSelectOptions = { render: renderWithLogo, valueField: 'id', labelField: 'nome', searchField: ['nome'] };
                    const multiSelectCheckboxOptions = { plugins: ['checkbox_options'], render: renderWithLogo, valueField: 'id', labelField: 'nome', searchField: ['nome'], placeholder: 'Selecione uma ou mais competições...', closeAfterSelect: false };

                    tsBulkCompeticao = new TomSelect(bulkModalElements.competicao, singleSelectOptions);
                    tsJogoCompeticao = new TomSelect(singleGameElements.competicao, singleSelectOptions);
                    tsJogoEquipaCasa = new TomSelect(singleGameElements.equipaCasa, singleSelectOptions);
                    tsJogoEquipaFora = new TomSelect(singleGameElements.equipaFora, singleSelectOptions);
                    tsEquipaCompeticoes = new TomSelect('#equipaCompeticoes', multiSelectCheckboxOptions);
                    
                    setupEventListeners();

                  // CÓDIGO NOVO PARA VALIDAR O PAÍS
    const paisNomeInput = document.getElementById('paisNome');
    const paisNomeErrorSpan = document.getElementById('paisNomeError');
    paisNomeInput.addEventListener('input', (e) => {
        const nomeAtual = e.target.value.trim().toLowerCase();
        if (nomeAtual === '') {
            paisNomeErrorSpan.textContent = '';
            return;
        }
        // A variável `allPaises` já está preenchida nesta fase
        const existe = allPaises.some(pais => pais.nome.toLowerCase() === nomeAtual);
        paisNomeErrorSpan.textContent = existe ? 'Este país já existe!' : '';
    });

    isInitialized = true;
}

                populateBulkModalDropdowns();
                populateIndividualTabDropdowns();
                populateCompetitionsForJogo();
                populateEquipasForJogo();
                
                const { resCasa, resFora, jornada, temporada } = singleGameElements;
             if(resCasa.innerHTML === '') {
    // Preenche os dropdowns de resultado
    for(let i=0; i<=9; i++) { 
        resCasa.innerHTML += `<option value="${i}">${i}</option>`; 
        resFora.innerHTML += `<option value="${i}">${i}</option>`; 
    }
    
    // Preenche o dropdown de jornada com os números 1-40
    for(let i=1; i<=60; i++) { 
        jornada.innerHTML += `<option value="${i}">${i}</option>`; 
    }
    
    // Adiciona as fases especiais ao dropdown de jornada
    const specialStages = ['1PE', '2PE', '3PE', 'POff', '1/8', 'QF', 'MF', '1F', 'F'];
    specialStages.forEach(stage => {
        jornada.innerHTML += `<option value="${stage}">${stage}</option>`;
    });
}

// LINHA ADICIONADA: Define o estado inicial do resultado final para "0-0"
updateResultadoFinal();
                temporada.innerHTML = '';
                allSeasons.forEach(s => { temporada.innerHTML += `<option value="${s.nome}">${s.nome}</option>`; });
                if(temporada.options.length > 0) temporada.selectedIndex = 0;

            } catch (error) { 
                if (!error.message.includes("Tom Select")) { console.error("Error fetching data: ", error); alert("Falha ao carregar dados: " + error.message); }
            }
        }
      
        function populateIndividualTabDropdowns() {
             [document.getElementById('jogadorNacionalidade'), document.getElementById('equipaPais'), document.getElementById('competicaoPais')].forEach(sel => {
                 if(sel) {
                     sel.innerHTML = '<option value="">Selecione...</option>';
                     allPaises.forEach(item => { sel.innerHTML += `<option value="${item.id}">${item.nome}</option>`; });
                 }
             });
             
             if (tsEquipaCompeticoes) {
                 tsEquipaCompeticoes.clear();
                 tsEquipaCompeticoes.clearOptions();
                 tsEquipaCompeticoes.addOptions(allCompetitions);
                 const preSeasonComp = allCompetitions.find(comp => comp.nome && comp.nome.trim().toLowerCase() === 'pre season');
                 if (preSeasonComp) {
                     tsEquipaCompeticoes.setValue([preSeasonComp.id]);
                 } else {
                     console.warn("A competição 'Pre Season' não foi encontrada para pré-seleção.");
                 }
             }
        }
        
        document.addEventListener('DOMContentLoaded', fetchAllInitialData);
    </script>
    
    <div id="videoPreviewPanel" class="floating-panel">
        <div class="panel-header">
            <h4>Pré-visualização do Vídeo</h4>
            <span id="closePreviewBtn" title="Fechar">×</span>
        </div>
        <div id="videoEmbedContainer"></div>
        <div class="panel-footer">
            <label>
                <input type="checkbox" id="useLinkOnlyCheckbox">
                Usar apenas link (não incorporar)
            </label>
        </div>
    </div>

<!-- NOVO POPUP DE DESAMBIGUAÇÃO -->
    <div id="disambiguationModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h4>Resolver Ambiguidade de Clube</h4>
            </div>
            <p style="margin-bottom: 15px;">O clube "<strong id="ambiguousClubName"></strong>" foi encontrado várias vezes. Por favor, selecione a equipa correta:</p>
            <div id="disambiguationOptions" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- As opções serão inseridas aqui pelo JavaScript -->
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button id="confirmDisambiguationBtn" class="action-btn">Confirmar Seleção</button>
            </div>
        </div>
    </div>
    <!-- FIM DO NOVO POPUP -->




</body>
</html>
