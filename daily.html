<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogos Diários</title>
    
    <style>
        /* ESTILOS (Com adições) */
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; color: #333; margin: 0; padding: 20px; font-size: 0.9em; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; padding: 20px; }
        h1 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5em; }
        .editor-main { display: flex; gap: 20px; min-height: 500px; }
        .navigation-column { flex: 1; border-right: 1px solid #ddd; padding-right: 20px; display: flex; flex-direction: column; gap: 15px; }
        .navigation-column select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        .filter-group { display: flex; gap: 10px; }
        .filter-group > div { flex: 1; }
        .nav-header h2 { font-size: 1.1em; margin: 0; color: #555; }
        .list-container { flex-grow: 1; overflow-y: auto; max-height: 500px; border: 1px solid #eee; border-radius: 4px; padding: 5px; }
        .nav-list { list-style: none; padding: 0; margin: 0; }
        .game-list-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; border: 1px solid transparent; transition: background-color 0.2s, border-color 0.2s; }
        .game-list-item:hover { background-color: #f0f2f5; }
        .game-list-item.active { background-color: #007bff; color: white; font-weight: bold; border-color: #0056b3; }
        
     .country-header {
            font-weight: bold;
            color: #444;
            background-color: #f7f7f7;
            padding: 8px 12px;
            margin-top: 10px;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            border-radius: 4px;
            /* **MODIFICADO** - Adicionado para alinhar bandeira e texto */
            display: flex; 
            align-items: center; 
        }
        .country-header:first-child { margin-top: 0; }

        /* **NOVO** Estilo para a bandeira do país */
        .country-flag {
            height: 16px; /* Altura controlada */
            width: auto;
            margin-right: 8px; /* Espaçamento à direita */
            border-radius: 2px;
            object-fit: contain;
        }

        .status-indicator { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
        .status-green { background-color: #28a745; }
        .status-red { background-color: #dc3545; }
        .loading-message, .info-message { color: #888; padding: 10px; }
        .edit-panel-column { flex: 1.5; }

.panel-header {
    display: flex;
    justify-content: space-between; /* Alinha o h2 à esquerda e o logo-container à direita */
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}
        .panel-header h2 { margin: 0; flex-shrink: 0; }
        .logo-container { display: flex; gap: 8px; align-items: center; }
.logo-container img {
    height: 32px;
    width: auto;
    object-fit: contain;
    /* a visibilidade será controlada via JS */
}

.team-name {
    font-weight: bold;
    color: #333;
    display: none; /* Escondido por defeito */
}

.vs-separator {
    color: #888;
    display: none; /* Escondido por defeito */
}

        #editForm fieldset { border: 1px solid #ddd; padding: 15px; border-radius: 4px; }
        #editForm fieldset:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-group { margin-bottom: 12px; display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 4px; font-weight: bold; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box; }
        #gameNameDisplay { font-weight: bold; background-color: #e9ecef; padding: 10px; border-radius: 4px; margin-bottom: 15px; min-height: 20px; word-break: break-word; }
        .score-inputs { display: flex; gap: 15px; }
        .score-inputs .form-group { flex: 1; }
.button-group {
    display: flex;
    justify-content: space-between; /* Essencial para o alinhamento */
    align-items: center;           /* Alinha verticalmente os botões e os logos */
    gap: 10px;
    margin-top: 15px;
}

#logoDisplayArea {
    display: flex;
    gap: 8px; /* Espaço entre os dois logos */
    align-items: center;
}

#logoDisplayArea img {
    height: 32px; /* Define uma altura para os logos */
    width: auto;
    object-fit: contain;
    display: none; /* Esconde os logos por defeito */
}        .action-btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
        .action-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        .save-btn { background-color: #28a745; color: white; }
        .search-btn { background-color: #6c757d; color: white; }
        #videoPreviewContainer { width: 100%; aspect-ratio: 16 / 9; background-color: #e9ecef; border-radius: 4px; margin-top: 15px; display: flex; align-items: center; justify-content: center; color: #888; overflow: hidden; }
        #videoPreviewContainer iframe { width: 100%; height: 100%; border: none; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; }
        .checkbox-group input { width: auto; }
        .checkbox-group label { margin-bottom: 0; font-weight: normal; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
.modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; border-radius: 8px; }
.modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; }
.modal-header h2 { margin: 0; }
.close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }

.channel-link-list {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 300px;
    overflow-y: auto;
}
.channel-link-list li a {
    display: block;
    padding: 12px 15px;
    text-decoration: none;
    color: #007bff;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
    word-break: break-all;
}
.channel-link-list li a:hover {
    background-color: #f0f2f5;
}
.channel-link-list .no-channels-message {
    padding: 15px;
    color: #888;
    text-align: center;
}

.action-btn.postponed-active {
    background-color: #6f42c1; /* Roxo, para indicar estado ativo */
    color: white;
    font-weight: bold;
    border: 1px solid #59369a;
}


#postponeBtn {
    background-color: #ffc107;
    color: #212529;
}

/* Define o estado ATIVO (roxo) com a mesma especificidade (ID + classe) */
#postponeBtn.postponed-active {
    background-color: #6f42c1; /* Roxo */
    color: white;
    font-weight: bold;
}

    </style>




</head>
<body>
    <div class="container">
        <h1>Jogos Diários</h1>
        <div class="editor-main">
            <div class="navigation-column">
                <div><label for="seasonSelector">Temporada</label><select id="seasonSelector"><option>A carregar...</option></select></div>
                <div class="filter-group">
                    <div><label for="monthSelector">Mês</label><select id="monthSelector"></select></div>
                    <div><label for="daySelector">Dia</label><select id="daySelector"></select></div>
                </div>
                <div class="nav-header"><h2>Jogos Encontrados</h2></div>
                <div class="list-container"><ul id="gamesList" class="nav-list"></ul></div>
            </div>
            <div class="edit-panel-column">
              <div class="panel-header">
    <h2>Painel de Edição</h2>
    <!-- O container de logos agora também inclui os nomes das equipas -->
    <div class="logo-container">
        <img id="logoCasa" src="" alt="Logo Equipa Casa">
        <span id="teamNameCasa" class="team-name"></span>
        <span class="vs-separator">vs</span>
        <span id="teamNameFora" class="team-name"></span>
        <img id="logoFora" src="" alt="Logo Equipa Visitante">
    </div>
</div>
                <form id="editForm">
                    <fieldset id="editFieldset" disabled>
                        <!-- **MODIFICADO** - Adicionado ícone de edição -->
                        <div class="form-group">
                            <label>Jogo Selecionado: 
                                <span id="openExtraInfoModalBtn" style="cursor: pointer; font-size: 1.1em; color: #007bff; display: none;" title="Editar detalhes do jogo">✎</span>
                            </label>
                            <div id="gameNameDisplay">Selecione um jogo da lista</div>
                        </div>
                        <div class="score-inputs">
                            <div class="form-group"><label for="resultadoCasaInput">Resultado Casa</label><input type="number" id="resultadoCasaInput" min="0" required></div>
                            <div class="form-group"><label for="resultadoForaInput">Resultado Fora</label><input type="number" id="resultadoForaInput" min="0" required></div>
                        </div>
                        <div class="form-group"><label for="videoUrlInput">Link do Vídeo (YouTube, etc.)</label><input type="url" id="videoUrlInput" placeholder="https://exemplo.com/video"></div>
                        <div class="checkbox-group"><input type="checkbox" id="useLinkOnlyCheckbox"><label for="useLinkOnlyCheckbox">Usar apenas link (não incorporar)</label></div>
                     <div class="button-group">
    <!-- Botões existentes (sem alterações aqui) -->
    <div>
        <button type="button" id="searchYouTubeBtn" class="action-btn search-btn">Procurar</button>
        <button type="button" id="channelsBtn" class="action-btn" style="background-color: #17a2b8;" disabled>Channels</button>
        <button type="submit" id="saveBtn" class="action-btn save-btn">Gravar Alterações</button>
    </div>

    <!-- NOVO: Contentor para os logos, alinhado à direita pelo CSS -->
    <div id="logoDisplayArea">
        <img id="logoCasaBtnLine" src="" alt="Logo Equipa Casa">
        <img id="logoForaBtnLine" src="" alt="Logo Equipa Visitante">
    </div>
</div>
                        <div id="videoPreviewContainer">Pré-visualização do vídeo</div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Canais (Existente) -->
    <div id="channelsLinkModal" class="modal" style="display: none; z-index: 1001;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Canais de Transmissão</h2>
                <span id="closeChannelsLinkBtn" class="close-btn" style="cursor: pointer;">×</span>
            </div>
            <div class="channel-list-container">
                <ul id="channelsLinkList" class="channel-link-list"></ul>
            </div>
        </div>
    </div>

    <!-- **NOVO** - Modal para Editar Informações Extra -->
    <div id="extraInfoModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Editar Informações Extra</h2>
                <span id="closeExtraInfoBtn" class="close-btn" style="cursor: pointer;">&times;</span>
            </div>
            <form id="extraInfoForm" novalidate>
                <div class="form-group">
                    <label for="extraInfoDate">Data do Jogo</label>
                    <input type="date" id="extraInfoDate" class="form-group input" required>
                </div>
                <div class="form-group">
                    <label for="extraInfoJornada">Jornada</label>
                    <select id="extraInfoJornada" class="form-group input" required></select>
                </div>
                <div class="form-group">
                    <label for="extraInfoTemporada">Temporada</label>
                    <select id="extraInfoTemporada" class="form-group input" required></select>
                </div>
                <div class="form-group">
                    <label for="extraInfoCompeticao">Competição</label>
                    <select id="extraInfoCompeticao" class="form-group input" required></select>
                </div>
             <div class="button-group">
                    <!-- NOVO BOTÃO -->
<button type="button" id="postponeBtn" class="action-btn">Postponed</button>
                    <!-- BOTÃO EXISTENTE -->
                    <button type="submit" id="saveExtraInfoBtn" class="action-btn save-btn">Guardar Alterações</button>
                </div>
            </form>
        </div>
    </div>








<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    
    // --- Config e Elementos DOM ---
    const firebaseConfig = { apiKey: "AIzaSyBa6zi1FV_WFkatQW-w2vb_votXJ43p76o", authDomain: "varsoccer-26040.firebaseapp.com", projectId: "varsoccer-26040", storageBucket: "varsoccer-26040.firebasestorage.app", messagingSenderId: "11877829810", appId: "1:11877829810:web:98f9baa131a3b88b6e8dab" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Elementos DOM principais
    const seasonSelector = document.getElementById('seasonSelector');
    const monthSelector = document.getElementById('monthSelector');
    const daySelector = document.getElementById('daySelector');
    const gamesList = document.getElementById('gamesList');
    const editFieldset = document.getElementById('editFieldset');
    const gameNameDisplay = document.getElementById('gameNameDisplay');
    const resultadoCasaInput = document.getElementById('resultadoCasaInput');
    const resultadoForaInput = document.getElementById('resultadoForaInput');
    const videoUrlInput = document.getElementById('videoUrlInput');
    const saveBtn = document.getElementById('saveBtn');
    const editForm = document.getElementById('editForm');
    const searchYouTubeBtn = document.getElementById('searchYouTubeBtn');
    const videoPreviewContainer = document.getElementById('videoPreviewContainer');
    const useLinkOnlyCheckbox = document.getElementById('useLinkOnlyCheckbox');
    const logoCasaImg = document.getElementById('logoCasa');
    const logoForaImg = document.getElementById('logoFora');
    const channelsBtn = document.getElementById('channelsBtn');
    const channelsLinkModal = document.getElementById('channelsLinkModal');
    const closeChannelsLinkBtn = document.getElementById('closeChannelsLinkBtn');
    const channelsLinkList = document.getElementById('channelsLinkList');
    
    const openExtraInfoModalBtn = document.getElementById('openExtraInfoModalBtn');
    const extraInfoModal = document.getElementById('extraInfoModal');
    const closeExtraInfoBtn = document.getElementById('closeExtraInfoBtn');
    const extraInfoForm = document.getElementById('extraInfoForm');
    const extraInfoDate = document.getElementById('extraInfoDate');
    const extraInfoJornada = document.getElementById('extraInfoJornada');
    const extraInfoTemporada = document.getElementById('extraInfoTemporada');
    const extraInfoCompeticao = document.getElementById('extraInfoCompeticao');
    const saveExtraInfoBtn = document.getElementById('saveExtraInfoBtn');
    const teamNameCasa = document.getElementById('teamNameCasa');
    const teamNameFora = document.getElementById('teamNameFora');
    const vsSeparator = document.querySelector('.vs-separator');
    const logoCasaBtnLine = document.getElementById('logoCasaBtnLine');
    const logoForaBtnLine = document.getElementById('logoForaBtnLine');
    
    const postponeBtn = document.getElementById('postponeBtn');

    // --- Estado da Aplicação ---
    let allGamesFromDb = []; 
    let filteredGames = [];
    let selectedGame = null;
    let paisesMap = new Map(); 
    let competicoesMap = new Map();
    let temporadasList = []; 
    let markAsPostponed = false;

    // --- Funções Auxiliares ---
    
    const getLogoUrl = async (teamId) => {
        if (!teamId) return null;
        try {
            const teamRef = doc(db, 'clubes', teamId);
            const teamSnap = await getDoc(teamRef);
            if (teamSnap.exists() && teamSnap.data().logoUrl) return teamSnap.data().logoUrl;
            return null;
        } catch (error) {
            console.error(`Erro ao buscar logo para equipa ${teamId}:`, error);
            return null;
        }
    };
    
    const loadCompeticoes = async () => {
        try {
            const competicoesSnapshot = await getDocs(query(collection(db, "competicoes"), orderBy("nome")));
            competicoesSnapshot.forEach(doc => {
                competicoesMap.set(doc.id, doc.data());
            });
        } catch (error) {
            console.error("Falha ao carregar competições:", error);
        }
    };

    const loadPaises = async () => {
        try {
            const paisesSnapshot = await getDocs(collection(db, "paises"));
            paisesSnapshot.forEach(doc => {
                paisesMap.set(doc.id, { nome: doc.data().nome, bandeiraUrl: doc.data().bandeiraUrl });
            });
        } catch (error) {
            console.error("Falha ao carregar países:", error);
        }
    };

    const loadAllGames = async () => {
        gamesList.innerHTML = '<li class="loading-message">A carregar todos os jogos...</li>';
        try {
            const gamesSnapshot = await getDocs(collection(db, "jogos"));
            allGamesFromDb = gamesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            gamesList.innerHTML = `<li class="info-message" style="color: red;">Falha ao carregar dados.</li>`;
            throw error;
        }
    };

    const initializeMonthSelector = () => {
        const today = new Date();
        const currentMonth = today.getMonth() + 1;
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        monthSelector.innerHTML = monthNames.map((name, index) => `<option value="${index + 1}">${name}</option>`).join('');
        monthSelector.value = currentMonth;
    };
    
    const updateDaySelectorWithCounts = () => {
        const selectedMonth = parseInt(monthSelector.value, 10);
        const selectedSeason = seasonSelector.value;
        const today = new Date();
        today.setHours(23, 59, 59, 999);
        const pendingCounts = {};
        allGamesFromDb.forEach(game => {
            if (!game.dataJogo || typeof game.dataJogo !== 'string') return;
            const dateParts = game.dataJogo.split('-');
            if (dateParts.length !== 3) return;
            const gameDate = new Date(game.dataJogo);
            const gameMonth = parseInt(dateParts[1], 10);
            const gameDay = parseInt(dateParts[2], 10);
            const isSeasonMatch = (selectedSeason === 'all' || game.temporada === selectedSeason);
            const isMonthMatch = gameMonth === selectedMonth;
            const hasNoVideo = !game.videoUrl || game.videoUrl.trim() === '';
            const isNotInFuture = gameDate <= today;
            if (isSeasonMatch && isMonthMatch && hasNoVideo && isNotInFuture) {
                pendingCounts[gameDay] = (pendingCounts[gameDay] || 0) + 1;
            }
        });
        const currentDay = daySelector.value || new Date().getDate();
        let optionsHtml = '';
        for (let i = 1; i <= 31; i++) {
            const count = pendingCounts[i] || 0;
            const displayCounter = count > 0 ? `  🔴 ${count}` : '';
            optionsHtml += `<option value="${i}">Dia ${i}${displayCounter}</option>`;
        }
        daySelector.innerHTML = optionsHtml;
        daySelector.value = currentDay;
    };

    const loadSeasonsAndSetDefault = async () => {
        const seasonsQuery = query(collection(db, "temporadas"), orderBy("nome", "desc"));
        const snapshot = await getDocs(seasonsQuery);
        temporadasList = snapshot.docs.map(doc => doc.data().nome); 
        const optionsHtml = temporadasList.map(nome => `<option value="${nome}">${nome}</option>`).join('');
        seasonSelector.innerHTML = '<option value="all">Todas as Temporadas</option>' + optionsHtml;
        if (temporadasList.length > 0) seasonSelector.value = temporadasList[0];
    };

    const formatGameDate = (dateString) => {
        if (!dateString || typeof dateString !== 'string') return '';
        const dateParts = dateString.split('-'); 
        if (dateParts.length !== 3) return dateString;
        return `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`; 
    };

    const clearEditPanel = () => {
        editFieldset.disabled = true;
        gameNameDisplay.textContent = 'Selecione um jogo da lista';
        editForm.reset();
        videoPreviewContainer.innerHTML = 'Pré-visualização do vídeo';
        selectedGame = null;
        logoCasaImg.style.display = 'none';
        logoForaImg.style.display = 'none';
        teamNameCasa.style.display = 'none';
        teamNameFora.style.display = 'none';
        vsSeparator.style.display = 'none';
        logoCasaImg.src = '';
        logoForaImg.src = '';
        logoCasaBtnLine.style.display = 'none';
        logoForaBtnLine.style.display = 'none';
        logoCasaBtnLine.src = '';
        logoForaBtnLine.src = '';
        openExtraInfoModalBtn.style.display = 'none';
        channelsBtn.disabled = true;
    };
    
    // --- Lógica Principal ---
    const applyFiltersAndRender = () => { 
        clearEditPanel();
        const selectedMonth = parseInt(monthSelector.value, 10);
        const selectedDay = parseInt(daySelector.value, 10);
        const selectedSeason = seasonSelector.value;
        filteredGames = allGamesFromDb.filter(game => {
            if (!game.dataJogo || typeof game.dataJogo !== 'string') return false;
            const dateParts = game.dataJogo.split('-');
            if (dateParts.length !== 3) return false;
            const gameMonth = parseInt(dateParts[1], 10);
            const gameDay = parseInt(dateParts[2], 10);
            const isDateMatch = gameDay === selectedDay && gameMonth === selectedMonth;
            const isSeasonMatch = (selectedSeason === 'all' || game.temporada === selectedSeason);
            return isDateMatch && isSeasonMatch;
        });
        renderGamesList();
    };

   const renderGamesList = () => {
        if (filteredGames.length === 0) {
            gamesList.innerHTML = '<li class="info-message">Nenhum jogo encontrado.</li>';
            return;
        }
        const gamesByPaisId = {};
        filteredGames.forEach(game => {
            const paisId = competicoesMap.get(game.competicaoId)?.paisId || 'unknown';
            if (!gamesByPaisId[paisId]) gamesByPaisId[paisId] = [];
            gamesByPaisId[paisId].push(game);
        });
        const sortedPaisIds = Object.keys(gamesByPaisId).sort((a, b) => {
            const nameA = paisesMap.has(a) ? paisesMap.get(a).nome : 'País Desconhecido';
            const nameB = paisesMap.has(b) ? paisesMap.get(b).nome : 'País Desconhecido';
            return nameA.localeCompare(nameB);
        });
        let listHtml = '';
        sortedPaisIds.forEach(paisId => {
            const countryData = paisesMap.get(paisId);
            const flagHtml = countryData?.bandeiraUrl ? `<img src="${countryData.bandeiraUrl}" alt="Bandeira de ${countryData.nome}" class="country-flag">` : '';
            listHtml += `<li class="country-header">${flagHtml}<span>${countryData?.nome || 'País Desconhecido'}</span></li>`;
            gamesByPaisId[paisId].forEach(game => {
                const hasVideo = game.videoUrl && game.videoUrl.trim() !== '';
                const statusClass = hasVideo ? 'status-green' : 'status-red';
                listHtml += `<li class="game-list-item" data-id="${game.id}"><span class="status-indicator ${statusClass}"></span><span>${game.nomeJogo || 'Jogo sem nome'}</span></li>`;
            });
        });
        gamesList.innerHTML = listHtml;
    };
    
    const selectGame = async (gameId) => {
        selectedGame = filteredGames.find(g => g.id === gameId);
        if (!selectedGame) return;
        document.querySelectorAll('#gamesList .active').forEach(el => el.classList.remove('active'));
        document.querySelector(`#gamesList li[data-id="${gameId}"]`).classList.add('active');
        editFieldset.disabled = false;
        openExtraInfoModalBtn.style.display = 'inline-block';
        channelsBtn.disabled = true; 

        const competicao = competicoesMap.get(selectedGame.competicaoId);
        if (competicao?.channels?.length > 0) {
            channelsBtn.disabled = false;
        }

        resultadoCasaInput.value = selectedGame.resultadoCasa ?? '';
        resultadoForaInput.value = selectedGame.resultadoFora ?? '';
        videoUrlInput.value = selectedGame.videoUrl || '';
        useLinkOnlyCheckbox.checked = !!selectedGame.apiYt;
        renderVideoPreview(videoUrlInput.value);
        updateGeneratedFields();
        teamNameCasa.textContent = selectedGame.equipaCasaNome;
        teamNameFora.textContent = selectedGame.equipaForaNome;
        teamNameCasa.style.display = 'inline';
        teamNameFora.style.display = 'inline';
        vsSeparator.style.display = 'inline';
        
        logoCasaImg.style.display = 'none';
        logoForaImg.style.display = 'none';
        const [logoCasaUrl, logoForaUrl] = await Promise.all([
            getLogoUrl(selectedGame.equipaCasaId),
            getLogoUrl(selectedGame.equipaForaId)
        ]);
        
        if (logoCasaUrl) { logoCasaImg.src = logoCasaUrl; logoCasaImg.style.display = 'block'; }
        if (logoForaUrl) { logoForaImg.src = logoForaUrl; logoForaImg.style.display = 'block'; }
        
        if (logoCasaUrl) { logoCasaBtnLine.src = logoCasaUrl; logoCasaBtnLine.style.display = 'block'; }
        if (logoForaUrl) { logoForaBtnLine.src = logoForaUrl; logoForaBtnLine.style.display = 'block'; }
    };
    
    const updateGeneratedFields = () => {
        if (!selectedGame) return;
        const casa = resultadoCasaInput.value;
        const fora = resultadoForaInput.value;
        const dataFormatada = formatGameDate(selectedGame.dataJogo);

        let resultadoDisplay = `${casa}-${fora}`;
        if (selectedGame.resultadoFinal === 'PPD') {
            resultadoDisplay = 'PPD';
        }

        gameNameDisplay.textContent = `${selectedGame.equipaCasaNome} ${resultadoDisplay} ${selectedGame.equipaForaNome} - ${dataFormatada}`;
    };

    const renderVideoPreview = (url) => {
        videoPreviewContainer.innerHTML = 'Pré-visualização do vídeo';
        if (!url || !url.trim()) return;
        const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const match = url.match(youtubeRegex);
        if (match && match[1]) {
            videoPreviewContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${match[1]}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
        } else {
            videoPreviewContainer.innerHTML = 'Link não suportado ou inválido para pré-visualização.';
        }
    };

    const populateExtraInfoModalDropdowns = () => {
        let jornadaHtml = '';
        for (let i = 1; i <= 60; i++) {
            jornadaHtml += `<option value="${i}">${i}</option>`;
        }
        extraInfoJornada.innerHTML = jornadaHtml;

        extraInfoTemporada.innerHTML = temporadasList.map(nome => `<option value="${nome}">${nome}</option>`).join('');

        let competicaoHtml = '';
        competicoesMap.forEach((comp, id) => {
            competicaoHtml += `<option value="${id}">${comp.nome}</option>`;
        });
        extraInfoCompeticao.innerHTML = competicaoHtml;
    };

    const openExtraInfoModal = () => {
        // MODIFICADO: Reseta o estado LÓGICO e VISUAL
        markAsPostponed = false;
        postponeBtn.classList.remove('postponed-active');

        if (!selectedGame) return;
        extraInfoDate.value = selectedGame.dataJogo || '';
        extraInfoJornada.value = selectedGame.jornada || '1';
        extraInfoTemporada.value = selectedGame.temporada || temporadasList[0];
        extraInfoCompeticao.value = selectedGame.competicaoId || '';
        
        extraInfoModal.style.display = 'block';
    };

    // --- Event Listeners ---
    seasonSelector.addEventListener('change', () => { updateDaySelectorWithCounts(); applyFiltersAndRender(); });
    monthSelector.addEventListener('change', () => { updateDaySelectorWithCounts(); applyFiltersAndRender(); });
    daySelector.addEventListener('change', applyFiltersAndRender);
    gamesList.addEventListener('click', async (e) => { const li = e.target.closest('.game-list-item'); if (li) await selectGame(li.dataset.id); });
    [resultadoCasaInput, resultadoForaInput].forEach(el => el.addEventListener('input', updateGeneratedFields));
    videoUrlInput.addEventListener('input', (e) => renderVideoPreview(e.target.value));

    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!selectedGame || saveBtn.disabled) return;
        saveBtn.disabled = true;
        saveBtn.textContent = 'A gravar...';
        const casa = resultadoCasaInput.value;
        const fora = resultadoForaInput.value;
        const updatedData = {
            resultadoCasa: casa,
            resultadoFora: fora,
            videoUrl: videoUrlInput.value.trim(),
            resultadoFinal: `${casa}-${fora}`,
            nomeJogo: `${selectedGame.equipaCasaNome} ${casa}-${fora} ${selectedGame.equipaForaNome} - ${formatGameDate(selectedGame.dataJogo)}`,
            apiYt: useLinkOnlyCheckbox.checked
        };
        try {
            await updateDoc(doc(db, 'jogos', selectedGame.id), updatedData);
            Object.assign(allGamesFromDb.find(g => g.id === selectedGame.id), updatedData);
            Object.assign(filteredGames.find(g => g.id === selectedGame.id), updatedData);
            Object.assign(selectedGame, updatedData);
            
            const listItem = document.querySelector(`#gamesList li[data-id="${selectedGame.id}"]`);
            if (listItem) {
                listItem.querySelector('.status-indicator').className = `status-indicator ${updatedData.videoUrl ? 'status-green' : 'status-red'}`;
                listItem.querySelector('span:last-child').textContent = updatedData.nomeJogo;
            }
            
            saveBtn.textContent = 'Gravado!';
            saveBtn.style.backgroundColor = '#218838';
            updateDaySelectorWithCounts();
        } catch (error) {
            console.error("Erro ao gravar alterações: ", error);
            alert("Ocorreu um erro ao gravar. Tente novamente.");
        } finally {
            setTimeout(() => {
                saveBtn.textContent = 'Gravar Alterações';
                saveBtn.style.backgroundColor = '#28a745';
                saveBtn.disabled = false;
            }, 2000);
        }
    });
    
 searchYouTubeBtn.addEventListener('click', () => {
    if (!selectedGame) return;

    let searchTerm = ''; // Declara a variável do termo de pesquisa

    // Verifica se o resultado final do jogo é PPD
    if (selectedGame.resultadoFinal === 'PPD') {
        // Se for PPD, usa um termo de busca genérico com "x"
        searchTerm = `${selectedGame.equipaCasaNome} x ${selectedGame.equipaForaNome} highlights`;
    } else {
        // Para todos os outros casos (com resultado), usa o texto do display
        searchTerm = `${gameNameDisplay.textContent} highlights`;
    }

    // A parte final é a mesma para ambos os casos
    const youtubeUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(searchTerm)}`;
    window.open(youtubeUrl, '_blank');
});

    channelsBtn.addEventListener('click', () => {
        if (!selectedGame?.competicaoId) return;
        channelsLinkList.innerHTML = '';
        const competicao = competicoesMap.get(selectedGame.competicaoId);
        if (competicao?.channels?.length > 0) {
            competicao.channels.forEach(link => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = link;
                a.target = '_blank';
                a.textContent = link;
                li.appendChild(a);
                channelsLinkList.appendChild(li);
            });
        } else {
            channelsLinkList.innerHTML = '<li class="no-channels-message">Nenhum canal encontrado.</li>';
        }
        channelsLinkModal.style.display = 'block';
    });
    closeChannelsLinkBtn.addEventListener('click', () => { channelsLinkModal.style.display = 'none'; });
    
    openExtraInfoModalBtn.addEventListener('click', openExtraInfoModal);
    closeExtraInfoBtn.addEventListener('click', () => { extraInfoModal.style.display = 'none'; });

    // MODIFICADO - Listener de toggle para o botão Postponed
    postponeBtn.addEventListener('click', () => {
        // Inverte o estado da flag
        markAsPostponed = !markAsPostponed;
        // Adiciona ou remove a classe CSS com base no estado da flag
        postponeBtn.classList.toggle('postponed-active', markAsPostponed);
    });
    
    extraInfoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!selectedGame || saveExtraInfoBtn.disabled) return;

        saveExtraInfoBtn.disabled = true;
        saveExtraInfoBtn.textContent = 'A guardar...';

        const newCompeticaoId = extraInfoCompeticao.value;
        const newCompeticaoNome = competicoesMap.get(newCompeticaoId)?.nome || '';
        
        const updatedData = {
            dataJogo: extraInfoDate.value,
            jornada: extraInfoJornada.value,
            temporada: extraInfoTemporada.value,
            competicaoId: newCompeticaoId,
            competicaoNome: newCompeticaoNome,
        };

        if (markAsPostponed) {
            Object.assign(updatedData, {
                resultadoFinal: 'PPD',
                resultadoCasa: null,
                resultadoFora: null
            });
            // Gera um nome de jogo atualizado para o estado PPD
            updatedData.nomeJogo = `${selectedGame.equipaCasaNome} PPD ${selectedGame.equipaForaNome} - ${formatGameDate(updatedData.dataJogo)}`;
        }
        
        try {
            await updateDoc(doc(db, 'jogos', selectedGame.id), updatedData);
            
            Object.assign(allGamesFromDb.find(g => g.id === selectedGame.id), updatedData);
            Object.assign(filteredGames.find(g => g.id === selectedGame.id), updatedData);
            Object.assign(selectedGame, updatedData);

            updateGeneratedFields();
            saveExtraInfoBtn.textContent = 'Guardado!';
            saveExtraInfoBtn.style.backgroundColor = '#218838';
            
            setTimeout(() => {
                extraInfoModal.style.display = 'none';
                saveExtraInfoBtn.textContent = 'Guardar Alterações';
                saveExtraInfoBtn.style.backgroundColor = '#28a745';
                saveExtraInfoBtn.disabled = false;
                applyFiltersAndRender();
            }, 1000);

        } catch (error) {
            console.error("Erro ao gravar informações extra:", error);
            alert("Ocorreu um erro ao gravar. Tente novamente.");
            saveExtraInfoBtn.disabled = false;
            saveExtraInfoBtn.textContent = 'Guardar Alterações';
        }
    });

    window.addEventListener('click', (event) => {
        if (event.target == channelsLinkModal) {
            channelsLinkModal.style.display = 'none';
        }
        if (event.target == extraInfoModal) {
            extraInfoModal.style.display = 'none';
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            await Promise.all([loadAllGames(), loadPaises(), loadCompeticoes(), loadSeasonsAndSetDefault()]);
            
            initializeMonthSelector();
            populateExtraInfoModalDropdowns();
            updateDaySelectorWithCounts();
            applyFiltersAndRender();
        } catch (error) {
            console.error("Falha na inicialização da aplicação:", error);
        }
    });

</script>
</body>
</html>
